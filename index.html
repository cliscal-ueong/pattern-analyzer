<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”íƒ€ë°ì´í„° íŒ¨í„´ ë¶„ì„ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(74, 144, 226, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            background: #F5FBFF;
            border: 3px dashed #4A90E2;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-section:hover {
            background: #E3F2FD;
            border-color: #1565C0;
        }

        .upload-section.dragover {
            background: #BBDEFB;
            border-color: #0D47A1;
        }

        .upload-icon {
            font-size: 4em;
            color: #4A90E2;
            margin-bottom: 20px;
        }

        .upload-section h3 {
            color: #1565C0;
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .upload-section p {
            color: #666;
            font-size: 1em;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #81D4FA 0%, #4FC3F7 100%);
        }

        .data-preview {
            margin-bottom: 30px;
            display: none;
        }

        .data-preview-header {
            cursor: pointer;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .data-preview-header:hover {
            background: linear-gradient(135deg, #BBDEFB 0%, #90CAF9 100%);
        }

        .data-preview-header h3 {
            color: #1565C0;
            font-size: 1.3em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            padding: 15px 25px;
            border-radius: 10px;
            border-left: 4px solid #4A90E2;
        }

        .stat-box strong {
            color: #1565C0;
            font-size: 1.1em;
        }

        .preview-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .preview-content.open {
            max-height: 500px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #BBDEFB;
            max-height: 300px;
            overflow-y: auto;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        thead {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #E3F2FD;
            font-size: 0.9em;
            white-space: nowrap;
            min-width: 80px;
        }

        td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #E3F2FD;
            font-size: 0.85em;
            white-space: nowrap;
        }

        tbody tr:hover {
            background: #F5FBFF;
        }

        tbody tr:nth-child(even) {
            background: #FAFAFA;
        }

        .analysis-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: white;
            color: #4A90E2;
            border: 2px solid #4A90E2;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
        }

        .tab-btn:hover {
            background: #E3F2FD;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
            border-color: #4A90E2;
        }

        .analysis-section {
            display: none;
        }

        .analysis-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .explanation-box {
            background: linear-gradient(135deg, #F5FBFF 0%, #E3F2FD 100%);
            border-left: 4px solid #4A90E2;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .explanation-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .explanation-toggle h4 {
            color: #1565C0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-icon {
            color: #4A90E2;
            font-size: 1.5em;
            transition: transform 0.3s;
        }

        .toggle-icon.open {
            transform: rotate(180deg);
        }

        .explanation-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .explanation-content.open {
            max-height: 500px;
            margin-top: 15px;
        }

        .explanation-content p {
            color: #444;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .explanation-content ul {
            margin-left: 20px;
            color: #444;
            line-height: 1.8;
        }

        .result-box {
            background: white;
            border: 1px solid #BBDEFB;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .result-box h4 {
            color: #1565C0;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-box {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4A90E2;
        }

        .summary-box h5 {
            color: #0D47A1;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .summary-box ul {
            list-style: none;
            padding: 0;
        }

        .summary-box li {
            color: #1565C0;
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
        }

        .summary-box li:before {
            content: "â—";
            color: #4A90E2;
            font-size: 1.2em;
            position: absolute;
            left: 0;
        }

        .conclusion-box {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CC 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #FFA726;
        }

        .conclusion-box h5 {
            color: #E65100;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conclusion-summary {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid #FFA726;
        }

        .conclusion-summary p {
            color: #333;
            line-height: 1.8;
            margin: 0;
            font-size: 1.05em;
            font-weight: 500;
        }

        .conclusion-actions {
            margin-top: 15px;
        }

        .conclusion-actions h6 {
            color: #E65100;
            font-size: 1em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .conclusion-actions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .conclusion-actions li {
            color: #444;
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
        }

        .conclusion-actions li:before {
            content: "â–¸";
            color: #FFA726;
            font-size: 1.2em;
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .chart-grid-item {
            background: white;
            border: 1px solid #BBDEFB;
            border-radius: 10px;
            padding: 20px;
        }

        .chart-grid-item h5 {
            color: #1565C0;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .chart-grid-item canvas {
            max-height: 250px;
        }

        .charts-toggle-section {
            margin-bottom: 20px;
        }

        .charts-toggle-btn {
            width: 100%;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            color: #1565C0;
            font-weight: 600;
            transition: all 0.3s;
        }

        .charts-toggle-btn:hover {
            background: linear-gradient(135deg, #BBDEFB 0%, #90CAF9 100%);
        }

        .charts-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .charts-content.open {
            max-height: 10000px;
        }

        .api-config-section {
            background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #9C27B0;
        }

        .api-config-section h4 {
            color: #6A1B9A;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .api-input {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: 2px solid #CE93D8;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #9C27B0;
            box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.1);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #6A1B9A;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #CE93D8;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-indicator.active {
            background: #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .ai-enhance-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #BA68C8 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .ai-enhance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }

        .ai-enhance-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .ai-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #9C27B0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .conclusion-ai {
            background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #9C27B0;
        }

        .conclusion-ai h6 {
            color: #6A1B9A;
            font-size: 1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conclusion-ai p {
            color: #444;
            line-height: 1.8;
            margin: 0;
        }

        .insight-toggle {
            cursor: pointer;
            user-select: none;
        }

        .insight-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .insight-content.open {
            max-height: 1000px;
            margin-top: 15px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .insight-badge {
            display: inline-block;
            background: #4A90E2;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .network-container {
            background: #F5FBFF;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #networkCanvas {
            max-width: 100%;
            cursor: grab;
        }

        #networkCanvas:active {
            cursor: grabbing;
        }

        .download-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4A90E2;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid #E3F2FD;
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #F5FBFF 0%, #E3F2FD 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #BBDEFB;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #1565C0;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }

            .upload-section {
                padding: 30px 20px;
            }

            .analysis-tabs {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ë©”íƒ€ë°ì´í„° íŒ¨í„´ ë¶„ì„ê¸°</h1>
            <p>ìƒí’ˆ ë©”íƒ€ë°ì´í„°ì˜ ìˆ¨ê²¨ì§„ íŒ¨í„´ì„ ë°œê²¬í•˜ì„¸ìš”</p>
        </div>

        <div class="content">
            <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“</div>
                <h3>ì—‘ì…€ ë˜ëŠ” CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
                <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
            </div>

            <!-- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
            <div class="data-preview" id="dataPreview">
                <div class="data-preview-header" onclick="toggleDataPreview()">
                    <h3>ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
                    <span class="toggle-icon" id="previewToggleIcon">â–¼</span>
                </div>
                <div class="preview-content" id="previewContent">
                    <div class="data-stats" id="dataStats"></div>
                    <div class="table-container" id="tableContainer"></div>
                </div>
            </div>

            <!-- Gemini API ì„¤ì • -->
            <div class="api-config-section" id="apiConfigSection" style="display: none;">
                <h4>ğŸ¤– AI ë¶„ì„ í–¥ìƒ (Gemini API)</h4>
                
                <!-- API ì…ë ¥ ì˜ì—­ -->
                <div id="apiInputArea">
                    <div class="api-input-group">
                        <input type="password" 
                               class="api-input" 
                               id="geminiApiKey" 
                               placeholder="Gemini API í‚¤ ì…ë ¥ (ì˜ˆ: AIzaSy...)"
                               onchange="saveApiKey()">
                        <button class="btn btn-secondary" onclick="saveApiKey()" style="white-space: nowrap;">
                            ì—°ê²°í•˜ê¸°
                        </button>
                    </div>
                    <p style="color: #666; font-size: 0.85em; margin-top: 10px; line-height: 1.6;">
                        ğŸ’¡ <strong>API í‚¤ ë°œê¸‰ ë°©ë²•:</strong><br>
                        1. <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #9C27B0;">Google AI Studio</a> ì ‘ì†<br>
                        2. "Create API key" í´ë¦­<br>
                        3. í”„ë¡œì íŠ¸ ì„ íƒ ë˜ëŠ” ìƒì„± (ì˜ˆ: pattern-analysis)<br>
                        4. ìƒì„±ëœ API í‚¤ ë³µì‚¬ í›„ ìœ„ì— ì…ë ¥<br>
                        <br>
                        âœ¨ <strong>ë¬´ë£Œ í•œë„:</strong> Gemini 1.5 Flash (ë¶„ë‹¹ 15íšŒ, ì¼ì¼ 1,500íšŒ)<br>
                        ğŸ”’ API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                </div>
                
                <!-- API ìƒíƒœ ì˜ì—­ -->
                <div id="apiStatusArea" style="display: none;">
                    <div class="api-status">
                        <span class="status-indicator active" id="apiStatusIndicator"></span>
                        <span id="apiStatusText" style="color: #4CAF50; font-weight: 600;">API ì—°ê²°ë¨</span>
                        <button class="btn" onclick="disconnectApi()" style="margin-left: auto; font-size: 0.9em; padding: 8px 16px;">
                            ì—°ê²° í•´ì œ
                        </button>
                    </div>
                    <p style="color: #666; font-size: 0.85em; margin-top: 10px;">
                        âœ¨ ê° ë¶„ì„ í˜ì´ì§€ì—ì„œ <strong>"AIë¡œ ë¶„ì„ í–¥ìƒí•˜ê¸°"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                    </p>
                </div>
            </div>

            <!-- ë¶„ì„ íƒ­ -->
            <div class="analysis-tabs" id="analysisTabs" style="display: none;">
                <button class="tab-btn active" data-tab="frequency">ğŸ“ˆ ê¸°ë³¸ ë¹ˆë„ ë¶„ì„</button>
                <button class="tab-btn" data-tab="combination">ğŸ”— ì¡°í•© íŒ¨í„´ ë¶„ì„</button>
                <button class="tab-btn" data-tab="association">ğŸ¯ ì—°ê´€ ê·œì¹™ ë¶„ì„</button>
                <button class="tab-btn" data-tab="visual">ğŸ—ºï¸ ë¹„ì£¼ì–¼ ë§µí•‘</button>
            </div>

            <!-- ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ë“¤ -->
            <div id="analysisResults"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let charts = {};
        let geminiApiKey = localStorage.getItem('geminiApiKey') || '';

        // API í‚¤ ì €ì¥ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        async function saveApiKey() {
            const input = document.getElementById('geminiApiKey');
            const apiKey = input.value.trim();
            
            if (!apiKey) {
                alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // API í‚¤ í…ŒìŠ¤íŠ¸
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            const models = ['gemini-2.5-flash', 'gemini-2.0-flash', 'gemini-2.5-pro'];
            let success = false;
            let workingModel = null;
            
            for (const model of models) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: 'ì•ˆë…•'
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 10,
                            }
                        })
                    });

                    if (response.ok) {
                        success = true;
                        workingModel = model;
                        break;
                    }
                } catch (error) {
                    continue;
                }
            }
            
            testBtn.disabled = false;
            testBtn.textContent = originalText;
            
            if (success) {
                // ì„±ê³µ ì‹œ ì €ì¥
                geminiApiKey = apiKey;
                localStorage.setItem('geminiApiKey', geminiApiKey);
                updateApiStatus(true);
                
                // UI ì „í™˜
                document.getElementById('apiInputArea').style.display = 'none';
                document.getElementById('apiStatusArea').style.display = 'block';
                
                alert(`âœ… API ì—°ê²° ì„±ê³µ!\n\nì‚¬ìš© ëª¨ë¸: ${workingModel}\n\nì´ì œ ê° ë¶„ì„ì—ì„œ "AIë¡œ ë¶„ì„ í–¥ìƒí•˜ê¸°" ë²„íŠ¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            } else {
                alert(`âŒ API ì—°ê²° ì‹¤íŒ¨\n\nëª¨ë“  ëª¨ë¸ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. Google Cloud Console (console.cloud.google.com) ì ‘ì†\n2. í”„ë¡œì íŠ¸ ì„ íƒ (pattern-analysis)\n3. "API ë° ì„œë¹„ìŠ¤" â†’ "ë¼ì´ë¸ŒëŸ¬ë¦¬"\n4. "Generative Language API" ê²€ìƒ‰ í›„ í™œì„±í™”\n5. ìƒˆ API í‚¤ ë°œê¸‰ í›„ ì¬ì‹œë„`);
            }
        }

        function disconnectApi() {
            if (confirm('API ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                geminiApiKey = '';
                localStorage.removeItem('geminiApiKey');
                document.getElementById('geminiApiKey').value = '';
                
                // UI ì „í™˜
                document.getElementById('apiInputArea').style.display = 'block';
                document.getElementById('apiStatusArea').style.display = 'none';
                
                updateApiStatus(false);
            }
        }

        function updateApiStatus(isActive) {
            const indicator = document.getElementById('apiStatusIndicator');
            const text = document.getElementById('apiStatusText');
            
            if (isActive) {
                indicator.classList.add('active');
                text.textContent = 'API ì—°ê²°ë¨';
                text.style.color = '#4CAF50';
            } else {
                indicator.classList.remove('active');
                text.textContent = 'API ë¯¸ì—°ê²°';
                text.style.color = '#666';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ API í‚¤ ë³µì›
        window.addEventListener('load', () => {
            if (geminiApiKey) {
                document.getElementById('geminiApiKey').value = geminiApiKey;
                document.getElementById('apiInputArea').style.display = 'none';
                document.getElementById('apiStatusArea').style.display = 'block';
                updateApiStatus(true);
            }
        });

        // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í† ê¸€
        function toggleDataPreview() {
            const content = document.getElementById('previewContent');
            const icon = document.getElementById('previewToggleIcon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // Gemini API í˜¸ì¶œ (ì—¬ëŸ¬ ëª¨ë¸ ì‹œë„)
        async function callGeminiAPI(prompt) {
            if (!geminiApiKey) {
                alert('Gemini API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return null;
            }

            // ì‹œë„í•  ëª¨ë¸ ëª©ë¡ (2025ë…„ ìµœì‹  ëª¨ë¸)
            const models = [
                'gemini-2.5-flash',
                'gemini-2.0-flash',
                'gemini-2.5-pro'
            ];

            let lastError = null;

            for (const model of models) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 1000,
                            }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        if (!data.candidates || !data.candidates[0]) {
                            throw new Error('API ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        }
                        
                        return data.candidates[0].content.parts[0].text;
                    }

                    lastError = await response.json().catch(() => ({}));
                    
                } catch (error) {
                    lastError = error;
                    continue; // ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                }
            }

            // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨
            console.error('ëª¨ë“  ëª¨ë¸ ì‹œë„ ì‹¤íŒ¨:', lastError);
            alert(`AI ë¶„ì„ ì˜¤ë¥˜\n\nëª¨ë“  ëª¨ë¸ ì—°ê²° ì‹¤íŒ¨. API ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\ní•´ê²° ë°©ë²•:\n1. Google AI Studioì—ì„œ "Generative Language API" í™œì„±í™”\n2. API í‚¤ ì¬ìƒì„±\n3. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸`);
            return null;
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    currentData = jsonData;
                    displayDataPreview(jsonData);
                    initializeAnalysis();
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function displayDataPreview(data) {
            const previewSection = document.getElementById('dataPreview');
            const statsDiv = document.getElementById('dataStats');
            const tableDiv = document.getElementById('tableContainer');

            // í†µê³„ í‘œì‹œ
            const columns = Object.keys(data[0]);
            statsDiv.innerHTML = `
                <div class="stat-box">
                    <strong>${data.length}</strong> ê°œì˜ ìƒí’ˆ
                </div>
                <div class="stat-box">
                    <strong>${columns.length}</strong> ê°œì˜ ë©”íƒ€ë°ì´í„°
                </div>
            `;

            // í…Œì´ë¸” ìƒì„± (ìƒìœ„ 10ê°œë§Œ)
            const previewData = data.slice(0, 10);
            let tableHTML = '<table><thead><tr>';
            columns.forEach(col => {
                tableHTML += `<th>${col}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            previewData.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(col => {
                    tableHTML += `<td>${row[col] || '-'}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';

            tableDiv.innerHTML = tableHTML;
            previewSection.style.display = 'block';
            
            // API ì„¤ì • ì„¹ì…˜ í‘œì‹œ
            document.getElementById('apiConfigSection').style.display = 'block';
        }

        function initializeAnalysis() {
            document.getElementById('analysisTabs').style.display = 'flex';
            
            // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const tab = btn.dataset.tab;
                    showAnalysis(tab);
                });
            });

            // ì²« ë²ˆì§¸ ë¶„ì„ í‘œì‹œ
            showAnalysis('frequency');
        }

        function showAnalysis(type) {
            const resultsDiv = document.getElementById('analysisResults');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            switch(type) {
                case 'frequency':
                    resultsDiv.innerHTML = generateFrequencyAnalysis();
                    break;
                case 'combination':
                    resultsDiv.innerHTML = generateCombinationAnalysis();
                    break;
                case 'association':
                    resultsDiv.innerHTML = generateAssociationAnalysis();
                    break;
                case 'visual':
                    resultsDiv.innerHTML = generateVisualMapping();
                    break;
            }

            // í† ê¸€ ì´ë²¤íŠ¸ ì¶”ê°€
            document.querySelectorAll('.explanation-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.toggle-icon');
                    content.classList.toggle('open');
                    icon.classList.toggle('open');
                });
            });
        }

        function generateFrequencyAnalysis() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );

            let html = `
                <div class="analysis-section active">
                    <div class="explanation-box">
                        <div class="explanation-toggle">
                            <h4>ğŸ’¡ ê¸°ë³¸ ë¹ˆë„ ë¶„ì„ì´ë€?</h4>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>ë­í•˜ëŠ” ê±°:</strong> ê° ë©”íƒ€ë°ì´í„° íŠ¹ì„±ì´ ëª‡ ë²ˆ ë‚˜íƒ€ë‚˜ëŠ”ì§€ ì„¸ëŠ” ë¶„ì„ì…ë‹ˆë‹¤.</p>
                            <p><strong>ë…¼ë¦¬:</strong> ë§ì´ ë‚˜íƒ€ë‚œ íŠ¹ì„± = ì˜ íŒ”ë¦¬ëŠ” ìƒí’ˆë“¤ì´ ê³µí†µì ìœ¼ë¡œ ê°€ì§„ íŠ¹ì„±</p>
                            <p><strong>í™œìš©:</strong> "ìš°ë¦¬ ìƒìœ„ ìƒí’ˆë“¤ì€ ì£¼ë¡œ ì–´ë–¤ íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆë‚˜?" íŒŒì•…</p>
                        </div>
                    </div>

                    <div class="conclusion-box">
                        <h5>ğŸ“ AI ë¶„ì„ ê²°ë¡ </h5>
                        <div id="frequencyConclusion">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                            </p>
                        </div>
                        <button class="ai-enhance-btn" onclick="enhanceFrequencyWithAI()" id="frequencyAiBtn">
                            âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                        <div id="frequencyAiResult" style="display: none;"></div>
                    </div>

                    <div class="summary-box">
                        <div class="insight-toggle">
                            <h5 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š í•µì‹¬ ë¶„ì„ ë‚´ìš©</span>
                                <span class="toggle-icon" style="font-size: 1.2em;">â–¼</span>
                            </h5>
                        </div>
                        <div class="insight-content">
                            <ul id="frequencySummary"></ul>
                        </div>
                    </div>

                    <div class="charts-toggle-section">
                        <button class="charts-toggle-btn" onclick="toggleCharts('frequency')">
                            <span>ğŸ“ˆ ìƒì„¸ ì°¨íŠ¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°</span>
                            <span class="toggle-icon" id="chartsToggleIcon">â–¼</span>
                        </button>
                        <div class="charts-content" id="frequencyCharts">
                            <div class="chart-grid" id="frequencyChartGrid"></div>
                        </div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-secondary" onclick="downloadFrequencyResults()">ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const summary = [];
                const topItems = [];
                let gridHTML = '';
                
                columns.forEach((col, index) => {
                    const frequency = calculateFrequency(col);
                    
                    const topValue = Object.entries(frequency).sort((a, b) => b[1] - a[1])[0];
                    summary.push(`<li><strong>${col}:</strong> "${topValue[0]}" í•­ëª©ì´ ${topValue[1]}ê°œ (${((topValue[1]/currentData.length)*100).toFixed(1)}%)</li>`);
                    topItems.push({ column: col, value: topValue[0], count: topValue[1], percent: ((topValue[1]/currentData.length)*100).toFixed(1) });
                    
                    // ê·¸ë¦¬ë“œ ì•„ì´í…œ ìƒì„±
                    gridHTML += `
                        <div class="chart-grid-item">
                            <h5>${col}</h5>
                            <canvas id="freqChart${index}"></canvas>
                        </div>
                    `;
                });
                
                document.getElementById('frequencyChartGrid').innerHTML = gridHTML;
                
                // ì°¨íŠ¸ ìƒì„± (ê·¸ë¦¬ë“œ ìƒì„± í›„)
                columns.forEach((col, index) => {
                    const frequency = calculateFrequency(col);
                    createFrequencyChart(`freqChart${index}`, col, frequency);
                });
                
                document.getElementById('frequencySummary').innerHTML = summary.join('');
                
                // ì¸ì‚¬ì´íŠ¸ í† ê¸€ ì´ë²¤íŠ¸
                document.querySelector('.insight-toggle').addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.toggle-icon');
                    content.classList.toggle('open');
                    icon.classList.toggle('open');
                });
            }, 100);

            return html;
        }

        function toggleCharts(section) {
            const chartsDiv = document.getElementById(`${section}Charts`);
            const icon = document.getElementById('chartsToggleIcon');
            chartsDiv.classList.toggle('open');
            icon.classList.toggle('open');
        }

        function generateFrequencyConclusion(topItems, totalColumns) {
            const dominant = topItems.filter(item => item.percent >= 50);
            const top3 = topItems.slice(0, 3);
            
            let html = '<div class="conclusion-summary"><p>';
            
            if (dominant.length > 0) {
                html += `<strong>ì••ë„ì  íŒ¨í„´:</strong> ${dominant.map(item => `${item.column}="${item.value}"(${item.percent}%)`).join(', ')}`;
            } else {
                html += `<strong>ì£¼ìš” íŒ¨í„´:</strong> ${top3.map(item => `${item.column}="${item.value}"(${item.percent}%)`).join(', ')}`;
            }
            
            html += '</p></div>';
            
            html += '<div class="conclusion-actions"><h6>ğŸ’¡ ì‹¤í–‰ ì „ëµ</h6><ul>';
            html += `<li>ì‹ ê·œ ì½˜í…ì¸ ëŠ” <strong>${top3[0].column}="${top3[0].value}"</strong> ì¤‘ì‹¬ìœ¼ë¡œ ê¸°íš</li>`;
            html += `<li>ê²€ì¦ëœ ì¡°í•©: ${top3.slice(0, 2).map(item => `${item.column}="${item.value}"`).join(' + ')}</li>`;
            
            const diverse = topItems.filter(item => item.percent < 30);
            if (diverse.length > 0) {
                html += `<li>ì°¨ë³„í™” í¬ì¸íŠ¸: ${diverse.slice(0, 2).map(item => item.column).join(', ')} í™œìš©</li>`;
            }
            
            html += '</ul></div>';
            
            return html;
        }

        // AI í–¥ìƒ í•¨ìˆ˜ë“¤
        async function enhanceFrequencyWithAI() {
            const btn = document.getElementById('frequencyAiBtn');
            const resultDiv = document.getElementById('frequencyConclusion');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="ai-loading"></span> AI ë¶„ì„ ì¤‘...';
            
            // ë°ì´í„° ìš”ì•½ ìƒì„±
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            
            const summary = columns.map(col => {
                const freq = calculateFrequency(col);
                const top = Object.entries(freq).sort((a, b) => b[1] - a[1])[0];
                return `${col}: "${top[0]}" (${((top[1]/currentData.length)*100).toFixed(1)}%)`;
            }).join('\n');
            
            const prompt = `ë‹¹ì‹ ì€ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒì€ ìƒìœ„ ${currentData.length}ê°œ ìƒí’ˆì˜ ë©”íƒ€ë°ì´í„° ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤:

${summary}

ìœ„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•œ ì‹¤ìš©ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

1. **í•µì‹¬ íŒ¨í„´ ìš”ì•½**: ê°€ì¥ ë‘ë“œëŸ¬ì§„ 3ê°€ì§€ íŠ¹ì„±
2. **ì‹¤í–‰ ì „ëµ**: ì‹ ê·œ ì½˜í…ì¸  ê¸°íš ì‹œ ì ìš©í•  êµ¬ì²´ì ì¸ ë©”íƒ€ë°ì´í„° ì¡°í•©
3. **ì°¨ë³„í™” í¬ì¸íŠ¸**: ê²½ìŸì‚¬ì™€ ì°¨ë³„í™”í•  ìˆ˜ ìˆëŠ” ì˜ì—­

í•œêµ­ì–´ë¡œ 5-6ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ì‘ì„±í•˜ë˜, ì‹¤ë¬´ì— ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ í¬í•¨í•´ì£¼ì„¸ìš”.`;
            
            const result = await callGeminiAPI(prompt);
            
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ AI ë¶„ì„ ë‹¤ì‹œí•˜ê¸°';
            
            if (result) {
                resultDiv.innerHTML = `<div class="conclusion-ai"><p>${result.replace(/\n/g, '<br><br>')}</p></div>`;
            }
        }

        async function enhanceCombinationWithAI() {
            const btn = document.getElementById('combinationAiBtn');
            const resultDiv = document.getElementById('combinationConclusion');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="ai-loading"></span> AI ë¶„ì„ ì¤‘...';
            
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            const combinations = findTopCombinations(columns, 2);
            const top5 = combinations.slice(0, 5).map(c => `${c.pattern} (${c.count}íšŒ)`).join('\n');
            
            const prompt = `ë‹¹ì‹ ì€ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒì€ ìƒìœ„ ì¡°í•© íŒ¨í„´ì…ë‹ˆë‹¤:

${top5}

ìœ„ ì¡°í•© íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬:

1. **ê°€ì¥ ê°•ë ¥í•œ ì¡°í•©ì˜ ì˜ë¯¸**: ì™œ ì´ ì¡°í•©ì´ íš¨ê³¼ì ì¸ê°€
2. **ì‹¤í–‰ ê°€ì´ë“œ**: ì´ ì¡°í•©ì„ ì–´ë–»ê²Œ í™œìš©í•  ê²ƒì¸ê°€
3. **í™•ì¥ ì „ëµ**: ê²€ì¦ëœ ì¡°í•© ê¸°ë°˜ ìƒˆë¡œìš´ ì‹œë„

í•œêµ­ì–´ë¡œ 5-6ë¬¸ì¥ìœ¼ë¡œ ì‹¤ë¬´ì— ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ ì „ëµì„ ì œì‹œí•´ì£¼ì„¸ìš”.`;
            
            const result = await callGeminiAPI(prompt);
            
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ AI ë¶„ì„ ë‹¤ì‹œí•˜ê¸°';
            
            if (result) {
                resultDiv.innerHTML = `<div class="conclusion-ai"><p>${result.replace(/\n/g, '<br><br>')}</p></div>`;
            }
        }

        async function enhanceAssociationWithAI() {
            const btn = document.getElementById('associationAiBtn');
            const resultDiv = document.getElementById('associationConclusion');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="ai-loading"></span> AI ë¶„ì„ ì¤‘...';
            
            const rules = calculateAssociationRules();
            
            if (rules.length === 0) {
                resultDiv.innerHTML = '<p style="color: #666; text-align: center;">ìœ ì˜ë¯¸í•œ ì—°ê´€ ê·œì¹™ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë” ë§ì€ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•´ë³´ì„¸ìš”.</p>';
                btn.disabled = false;
                btn.innerHTML = 'âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°';
                return;
            }
            
            const top5 = rules.slice(0, 5).map(r => `${r.rule} (ì‹ ë¢°ë„ ${(r.confidence*100).toFixed(1)}%)`).join('\n');
            
            const prompt = `ë‹¹ì‹ ì€ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒì€ ì—°ê´€ ê·œì¹™ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤:

${top5}

ìœ„ ê·œì¹™ë“¤ì„ ë¶„ì„í•˜ì—¬:

1. **ê°€ì¥ ì¤‘ìš”í•œ ê·œì¹™ í•´ì„**: ì‹¤ë¬´ì  ì˜ë¯¸
2. **ì ìš© ì „ëµ**: ì½˜í…ì¸  ê¸°íš ì‹œ í™œìš© ë°©ë²•
3. **ì£¼ì˜ì‚¬í•­**: ê·œì¹™ ì ìš© ì‹œ ê³ ë ¤í•  ì 

í•œêµ­ì–´ë¡œ 5-6ë¬¸ì¥ìœ¼ë¡œ ì‹¤ë¬´ì— ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.`;
            
            const result = await callGeminiAPI(prompt);
            
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ AI ë¶„ì„ ë‹¤ì‹œí•˜ê¸°';
            
            if (result) {
                resultDiv.innerHTML = `<div class="conclusion-ai"><p>${result.replace(/\n/g, '<br><br>')}</p></div>`;
            }
        }

        async function enhanceVisualWithAI() {
            const btn = document.getElementById('visualAiBtn');
            const resultDiv = document.getElementById('visualConclusion');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="ai-loading"></span> AI ë¶„ì„ ì¤‘...';
            
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            
            const diversityData = columns.map(col => {
                const freq = calculateFrequency(col);
                return `${col}: ${Object.keys(freq).length}ê°œ ê³ ìœ ê°’`;
            }).join('\n');
            
            const prompt = `ë‹¹ì‹ ì€ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒì€ ë©”íƒ€ë°ì´í„°ë³„ ë‹¤ì–‘ì„± ë¶„ì„ì…ë‹ˆë‹¤:

${diversityData}

ìœ„ ë‹¤ì–‘ì„± íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬:

1. **ì§‘ì¤‘ vs ë‹¤ì–‘ ë©”íƒ€ë°ì´í„° ì „ëµ**: ì–´ë–¤ ê²ƒì€ ë”°ë¥´ê³ , ì–´ë–¤ ê²ƒì€ ì°¨ë³„í™”í•  ê²ƒì¸ê°€
2. **í‹ˆìƒˆ ê¸°íšŒ ë°œêµ´**: ë‹¤ì–‘ì„±ì´ ë†’ì€ ì˜ì—­ì—ì„œì˜ ê¸°íšŒ
3. **ì‹¤í–‰ ìš°ì„ ìˆœìœ„**: ë¬´ì—‡ë¶€í„° ì‹œì‘í•  ê²ƒì¸ê°€

í•œêµ­ì–´ë¡œ 5-6ë¬¸ì¥ìœ¼ë¡œ ì‹¤ë¬´ì— ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ì „ëµì„ ì œì‹œí•´ì£¼ì„¸ìš”.`;
            
            const result = await callGeminiAPI(prompt);
            
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ AI ë¶„ì„ ë‹¤ì‹œí•˜ê¸°';
            
            if (result) {
                resultDiv.innerHTML = `<div class="conclusion-ai"><p>${result.replace(/\n/g, '<br><br>')}</p></div>`;
            }
        }

        function calculateFrequency(column) {
            const frequency = {};
            currentData.forEach(row => {
                const value = row[column] || 'ì—†ìŒ';
                frequency[value] = (frequency[value] || 0) + 1;
            });
            return frequency;
        }

        function createFrequencyChart(canvasId, label, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
            
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(d => d[0]),
                    datasets: [{
                        label: 'ê°œìˆ˜',
                        data: sortedData.map(d => d[1]),
                        backgroundColor: 'rgba(74, 144, 226, 0.7)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function generateCombinationAnalysis() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );

            // 2ê°œ ì¡°í•© ë¶„ì„
            const combinations = findTopCombinations(columns, 2);

            let html = `
                <div class="analysis-section active">
                    <div class="explanation-box">
                        <div class="explanation-toggle">
                            <h4>ğŸ’¡ ì¡°í•© íŒ¨í„´ ë¶„ì„ì´ë€?</h4>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>ë­í•˜ëŠ” ê±°:</strong> 2~3ê°œì˜ ë©”íƒ€ë°ì´í„° íŠ¹ì„±ì´ í•¨ê»˜ ë‚˜íƒ€ë‚˜ëŠ” íšŸìˆ˜ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                            <p><strong>ë…¼ë¦¬:</strong> ë‹¨ë… íŠ¹ì„±ë³´ë‹¤ "ì¡°í•©ì˜ í˜"ì´ í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ë–¤ ì¡°í•©ì´ íš¨ê³¼ì ì¸ì§€ ì°¾ìŠµë‹ˆë‹¤.</p>
                            <p><strong>í™œìš©:</strong> "ì´ íŠ¹ì„±ë“¤ì„ í•¨ê»˜ ì“°ë©´ ì˜ íŒ”ë¦°ë‹¤" ê°™ì€ ì¡°í•© ì „ëµ ë„ì¶œ</p>
                        </div>
                    </div>

                    <div class="conclusion-box">
                        <h5>ğŸ“ AI ë¶„ì„ ê²°ë¡ </h5>
                        <div id="combinationConclusion">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                            </p>
                        </div>
                        <button class="ai-enhance-btn" onclick="enhanceCombinationWithAI()" id="combinationAiBtn">
                            âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                        <div id="combinationAiResult" style="display: none;"></div>
                    </div>

                    <div class="summary-box">
                        <div class="insight-toggle">
                            <h5 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š í•µì‹¬ ë¶„ì„ ë‚´ìš©</span>
                                <span class="toggle-icon" style="font-size: 1.2em;">â–¼</span>
                            </h5>
                        </div>
                        <div class="insight-content">
                            <ul id="combinationSummary"></ul>
                        </div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ”— ìƒìœ„ ì¡°í•© íŒ¨í„´ (TOP 10)</h4>
                        <div class="metric-grid" id="combinationGrid"></div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ“Š ì¡°í•© ë¹ˆë„ ì°¨íŠ¸</h4>
                        <div class="chart-container">
                            <canvas id="combinationChart"></canvas>
                        </div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-secondary" onclick="downloadCombinationResults()">ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const top10 = combinations.slice(0, 10);
                
                // ê·¸ë¦¬ë“œ ìƒì„±
                const gridHTML = top10.map((combo, idx) => `
                    <div class="metric-card">
                        <div class="metric-value">${combo.count}</div>
                        <div class="metric-label">${combo.pattern}</div>
                    </div>
                `).join('');
                document.getElementById('combinationGrid').innerHTML = gridHTML;

                // ì°¨íŠ¸ ìƒì„±
                createCombinationChart(top10);

                // ìš”ì•½ ìƒì„±
                const summary = [
                    `<li>ê°€ì¥ ë§ì´ ë‚˜íƒ€ë‚œ ì¡°í•©: <strong>${top10[0].pattern}</strong> (${top10[0].count}íšŒ)</li>`,
                    `<li>ì´ ${combinations.length}ê°œì˜ ê³ ìœ í•œ ì¡°í•© íŒ¨í„´ ë°œê²¬</li>`,
                    `<li>ìƒìœ„ 3ê°œ ì¡°í•©ì´ ì „ì²´ì˜ ${((top10.slice(0,3).reduce((sum, c) => sum + c.count, 0) / currentData.length) * 100).toFixed(1)}% ì°¨ì§€</li>`
                ];
                document.getElementById('combinationSummary').innerHTML = summary.join('');
                
                // ì¸ì‚¬ì´íŠ¸ í† ê¸€ ì´ë²¤íŠ¸
                const toggleBtn = document.querySelector('#combinationSummary')?.parentElement?.previousElementSibling;
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.toggle-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');
                    });
                }
            }, 100);

            return html;
        }

        function generateCombinationConclusion(top10, totalCombinations) {
            const topCombo = top10[0];
            const highFreq = top10.filter(c => c.count >= 3);
            
            let html = '<div class="conclusion-summary"><p>';
            html += `<strong>ìµœë‹¤ ì¡°í•©:</strong> "${topCombo.pattern}" (${topCombo.count}íšŒ)`;
            if (highFreq.length > 1) {
                html += ` ì™¸ <strong>${highFreq.length - 1}ê°œ ê³ ë¹ˆë„ ì¡°í•©</strong> ë°œê²¬`;
            }
            html += '</p></div>';
            
            html += '<div class="conclusion-actions"><h6>ğŸ’¡ ì‹¤í–‰ ì „ëµ</h6><ul>';
            html += `<li>ê²€ì¦ëœ ì¡°í•© ìš°ì„  ì ìš©: <strong>${topCombo.pattern}</strong></li>`;
            
            if (top10.length > 2) {
                const combo2 = top10[1].pattern.split(' + ').map(p => p.split(': ')[1]).join(' + ');
                html += `<li>ëŒ€ì•ˆ ì¡°í•©: ${combo2} (${top10[1].count}íšŒ)</li>`;
            }
            
            html += `<li>ì „ì²´ ${totalCombinations}ê°œ ì¡°í•© ì¤‘ í‹ˆìƒˆ ê¸°íšŒ ë°œêµ´ ê°€ëŠ¥</li>`;
            html += '</ul></div>';
            
            return html;
        }

        function findTopCombinations(columns, size) {
            const combinations = {};
            
            // ì£¼ìš” ì»¬ëŸ¼ ì„ íƒ (ë„ˆë¬´ ë§ìœ¼ë©´ ìƒìœ„ 5ê°œë§Œ)
            const mainColumns = columns.slice(0, Math.min(5, columns.length));
            
            currentData.forEach(row => {
                for (let i = 0; i < mainColumns.length - 1; i++) {
                    for (let j = i + 1; j < mainColumns.length; j++) {
                        const val1 = row[mainColumns[i]] || 'ì—†ìŒ';
                        const val2 = row[mainColumns[j]] || 'ì—†ìŒ';
                        const pattern = `${mainColumns[i]}: ${val1} + ${mainColumns[j]}: ${val2}`;
                        combinations[pattern] = (combinations[pattern] || 0) + 1;
                    }
                }
            });

            return Object.entries(combinations)
                .map(([pattern, count]) => ({ pattern, count }))
                .sort((a, b) => b.count - a.count);
        }

        function createCombinationChart(data) {
            const ctx = document.getElementById('combinationChart');
            if (!ctx) return;

            const shortLabels = data.map(d => {
                const pattern = d.pattern;
                if (pattern.length > 60) {
                    return pattern.substring(0, 60) + '...';
                }
                return pattern;
            });

            charts['combinationChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: shortLabels,
                    datasets: [{
                        label: 'ë¹ˆë„',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgba(92, 167, 247, 0.7)',
                        borderColor: 'rgba(92, 167, 247, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function generateAssociationAnalysis() {
            const rules = calculateAssociationRules();

            let html = `
                <div class="analysis-section active">
                    <div class="explanation-box">
                        <div class="explanation-toggle">
                            <h4>ğŸ’¡ ì—°ê´€ ê·œì¹™ ë¶„ì„ì´ë€?</h4>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>ë­í•˜ëŠ” ê±°:</strong> "A íŠ¹ì„±ì´ ìˆìœ¼ë©´ â†’ B íŠ¹ì„±ë„ ìì£¼ ë‚˜íƒ€ë‚œë‹¤" ê°™ì€ ê·œì¹™ì„ ì°¾ìŠµë‹ˆë‹¤.</p>
                            <p><strong>ë…¼ë¦¬:</strong> ì¸ê³¼ê´€ê³„ëŠ” ì•„ë‹ˆì§€ë§Œ, ê°•í•œ ì—°ê²°ê³ ë¦¬ë¥¼ ë°œê²¬í•©ë‹ˆë‹¤.</p>
                            <p><strong>í™œìš©:</strong> "ì´ íŠ¹ì„±ì„ ì“°ë©´ ì € íŠ¹ì„±ë„ í•¨ê»˜ ì¨ì•¼ íš¨ê³¼ì " ê°™ì€ ì „ëµ ë„ì¶œ</p>
                            <ul>
                                <li><strong>ì§€ì§€ë„(Support):</strong> í•´ë‹¹ ì¡°í•©ì´ ì „ì²´ì—ì„œ ì°¨ì§€í•˜ëŠ” ë¹„ìœ¨</li>
                                <li><strong>ì‹ ë¢°ë„(Confidence):</strong> Aê°€ ìˆì„ ë•Œ Bë„ ìˆì„ í™•ë¥ </li>
                            </ul>
                        </div>
                    </div>

                    ${currentData.length < 20 ? `
                    <div class="error-message">
                        âš ï¸ ì—°ê´€ ê·œì¹™ ë¶„ì„ì€ í†µê³„ì  ì‹ ë¢°ë„ë¥¼ ìœ„í•´ ìµœì†Œ 20ê°œ ì´ìƒì˜ ë°ì´í„°ê°€ ê¶Œì¥ë©ë‹ˆë‹¤. 
                        í˜„ì¬ ${currentData.length}ê°œì˜ ë°ì´í„°ë¡œ ë¶„ì„í•˜ë¯€ë¡œ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ì„¸ìš”.
                    </div>
                    ` : ''}

                    <div class="conclusion-box">
                        <h5>ğŸ“ AI ë¶„ì„ ê²°ë¡ </h5>
                        <div id="associationConclusion">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                            </p>
                        </div>
                        <button class="ai-enhance-btn" onclick="enhanceAssociationWithAI()" id="associationAiBtn">
                            âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                        <div id="associationAiResult" style="display: none;"></div>
                    </div>

                    <div class="summary-box">
                        <div class="insight-toggle">
                            <h5 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š í•µì‹¬ ë¶„ì„ ë‚´ìš©</span>
                                <span class="toggle-icon" style="font-size: 1.2em;">â–¼</span>
                            </h5>
                        </div>
                        <div class="insight-content">
                            <ul id="associationSummary"></ul>
                        </div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ¯ ê°•ë ¥í•œ ì—°ê´€ ê·œì¹™ (TOP 10)</h4>
                        <div id="rulesTable"></div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-secondary" onclick="downloadAssociationResults()">ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            `;

            setTimeout(() => {
                if (rules.length > 0) {
                    // í…Œì´ë¸” ìƒì„±
                    let tableHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ìˆœìœ„</th>
                                        <th>ê·œì¹™ (A â†’ B)</th>
                                        <th>ì‹ ë¢°ë„</th>
                                        <th>ì§€ì§€ë„</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    rules.slice(0, 10).forEach((rule, idx) => {
                        tableHTML += `
                            <tr>
                                <td>${idx + 1}</td>
                                <td>${rule.rule}</td>
                                <td><strong>${(rule.confidence * 100).toFixed(1)}%</strong></td>
                                <td>${(rule.support * 100).toFixed(1)}%</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table></div>';
                    document.getElementById('rulesTable').innerHTML = tableHTML;

                    // ìš”ì•½
                    const summary = [
                        `<li>ì´ <strong>${rules.length}ê°œ</strong>ì˜ ì—°ê´€ ê·œì¹™ ë°œê²¬</li>`,
                        `<li>ê°€ì¥ ê°•í•œ ê·œì¹™: <strong>${rules[0].rule}</strong> (ì‹ ë¢°ë„ ${(rules[0].confidence * 100).toFixed(1)}%)</li>`,
                        `<li>í‰ê·  ì‹ ë¢°ë„: ${(rules.reduce((sum, r) => sum + r.confidence, 0) / rules.length * 100).toFixed(1)}%</li>`
                    ];
                    document.getElementById('associationSummary').innerHTML = summary.join('');
                } else {
                    document.getElementById('rulesTable').innerHTML = '<p>ìœ ì˜ë¯¸í•œ ì—°ê´€ ê·œì¹™ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
                
                // ì¸ì‚¬ì´íŠ¸ í† ê¸€ ì´ë²¤íŠ¸
                const toggleBtn = document.querySelector('#associationSummary')?.parentElement?.previousElementSibling;
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.toggle-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');
                    });
                }
            }, 100);

            return html;
        }

        function generateAssociationConclusion(rules) {
            if (rules.length === 0) {
                return '<div class="conclusion-summary"><p>í˜„ì¬ ë°ì´í„°ì—ì„œëŠ” ëª…í™•í•œ ì—°ê´€ ê·œì¹™ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p></div>';
            }
            
            const strongRules = rules.filter(r => r.confidence >= 0.7);
            const topRule = rules[0];
            
            let html = '<div class="conclusion-summary"><p>';
            html += `<strong>ìµœê°• ê·œì¹™:</strong> ${topRule.rule} (ì‹ ë¢°ë„ ${(topRule.confidence * 100).toFixed(1)}%)`;
            if (strongRules.length > 1) {
                html += ` ì™¸ <strong>${strongRules.length - 1}ê°œ ê°•ë ¥í•œ ê·œì¹™</strong> ë°œê²¬`;
            }
            html += '</p></div>';
            
            html += '<div class="conclusion-actions"><h6>ğŸ’¡ ì‹¤í–‰ ì „ëµ</h6><ul>';
            
            if (strongRules.length > 0) {
                const ruleA = topRule.rule.split('â†’')[0].trim();
                const ruleB = topRule.rule.split('â†’')[1].trim();
                html += `<li>${ruleA} ì„ íƒ ì‹œ â†’ <strong>${ruleB} í•„ìˆ˜ ì ìš©</strong></li>`;
            }
            
            html += `<li>ê³¼ê±° ì„±ê³µ íŒ¨í„´ ê¸°ë°˜ìœ¼ë¡œ ë¦¬ìŠ¤í¬ ìµœì†Œí™”</li>`;
            
            if (currentData.length < 20) {
                html += `<li>âš ï¸ ë°ì´í„° ${currentData.length}ê°œë¡œ ì°¸ê³ ìš©, ë” ë§ì€ ë°ì´í„°ë¡œ ì¬ê²€ì¦ í•„ìš”</li>`;
            }
            
            html += '</ul></div>';
            
            return html;
        }

        function calculateAssociationRules() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            ).slice(0, 5); // ì£¼ìš” ì»¬ëŸ¼ë§Œ

            const rules = [];
            const minSupport = 0.2; // 20% ì´ìƒ
            const minConfidence = 0.5; // 50% ì´ìƒ

            for (let i = 0; i < columns.length; i++) {
                for (let j = 0; j < columns.length; j++) {
                    if (i === j) continue;

                    const colA = columns[i];
                    const colB = columns[j];

                    const valuesA = [...new Set(currentData.map(row => row[colA]))];
                    const valuesB = [...new Set(currentData.map(row => row[colB]))];

                    valuesA.forEach(valA => {
                        valuesB.forEach(valB => {
                            const countA = currentData.filter(row => row[colA] === valA).length;
                            const countAB = currentData.filter(row => 
                                row[colA] === valA && row[colB] === valB
                            ).length;

                            const support = countAB / currentData.length;
                            const confidence = countAB / countA;

                            if (support >= minSupport && confidence >= minConfidence) {
                                rules.push({
                                    rule: `${colA}="${valA}" â†’ ${colB}="${valB}"`,
                                    support: support,
                                    confidence: confidence,
                                    lift: confidence / (currentData.filter(row => row[colB] === valB).length / currentData.length)
                                });
                            }
                        });
                    });
                }
            }

            return rules.sort((a, b) => b.confidence - a.confidence);
        }

        function generateVisualMapping() {
            let html = `
                <div class="analysis-section active">
                    <div class="explanation-box">
                        <div class="explanation-toggle">
                            <h4>ğŸ’¡ ë¹„ì£¼ì–¼ ë§µí•‘ì´ë€?</h4>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>ë­í•˜ëŠ” ê±°:</strong> ë©”íƒ€ë°ì´í„° ê°„ì˜ ê´€ê³„ë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.</p>
                            <p><strong>ë…¼ë¦¬:</strong> ë³µì¡í•œ íŒ¨í„´ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ ë„¤íŠ¸ì›Œí¬ í˜•íƒœë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.</p>
                            <p><strong>í™œìš©:</strong> ì–´ë–¤ íŠ¹ì„±ë“¤ì´ ë°€ì ‘í•˜ê²Œ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ ì§ê´€ì ìœ¼ë¡œ ì´í•´</p>
                        </div>
                    </div>

                    <div class="conclusion-box">
                        <h5>ğŸ“ AI ë¶„ì„ ê²°ë¡ </h5>
                        <div id="visualConclusion">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                            </p>
                        </div>
                        <button class="ai-enhance-btn" onclick="enhanceVisualWithAI()" id="visualAiBtn">
                            âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                        <div id="visualAiResult" style="display: none;"></div>
                    </div>

                    <div class="summary-box">
                        <div class="insight-toggle">
                            <h5 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š í•µì‹¬ ë¶„ì„ ë‚´ìš©</span>
                                <span class="toggle-icon" style="font-size: 1.2em;">â–¼</span>
                            </h5>
                        </div>
                        <div class="insight-content">
                            <ul id="visualSummary"></ul>
                        </div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ—ºï¸ ë©”íƒ€ë°ì´í„° íˆíŠ¸ë§µ</h4>
                        <div class="chart-container" style="height: 600px;">
                            <canvas id="heatmapChart"></canvas>
                        </div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ“Š íŠ¹ì„±ë³„ ë‹¤ì–‘ì„± ë¹„êµ</h4>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">
                            * ê° ë©”íƒ€ë°ì´í„°ê°€ ì–¼ë§ˆë‚˜ ë‹¤ì–‘í•œ ê°’ì„ ê°€ì§€ëŠ”ì§€ ë³´ì—¬ì¤ë‹ˆë‹¤. ê°’ì´ í´ìˆ˜ë¡ ì„ íƒì§€ê°€ ë‹¤ì–‘í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
                        </p>
                        <div class="chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-secondary" onclick="downloadVisualResults()">ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const diversityData = createHeatmap();
                createRadarChart();

                const columns = Object.keys(currentData[0]).filter(col => 
                    !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
                );

                const summary = [
                    `<li>ì´ <strong>${columns.length}ê°œ</strong>ì˜ ë©”íƒ€ë°ì´í„° ë¶„ì„</li>`,
                    `<li>íˆíŠ¸ë§µ: ì§„í•œ ìƒ‰ìƒ = ë†’ì€ ë¹ˆë„ (ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ê°’)</li>`,
                    `<li>ë ˆì´ë” ì°¨íŠ¸: ê° ë©”íƒ€ë°ì´í„°ì˜ ë‹¤ì–‘ì„± ì¸¡ì • (ê³ ìœ ê°’ ê°œìˆ˜)</li>`,
                    `<li>ë‹¤ì–‘ì„±ì´ ë†’ì€ ë©”íƒ€ë°ì´í„° = ì°¨ë³„í™” í¬ì¸íŠ¸ë¡œ í™œìš© ê°€ëŠ¥</li>`
                ];
                document.getElementById('visualSummary').innerHTML = summary.join('');
                
                // ì¸ì‚¬ì´íŠ¸ í† ê¸€ ì´ë²¤íŠ¸
                const toggleBtn = document.querySelector('#visualSummary')?.parentElement?.previousElementSibling;
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.toggle-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');
                    });
                }
            }, 100);

            return html;
        }

        function generateVisualConclusion(diversityData) {
            const mostDiverse = diversityData.sort((a, b) => b.diversity - a.diversity).slice(0, 3);
            const leastDiverse = diversityData.sort((a, b) => a.diversity - b.diversity).slice(0, 3);
            
            let html = '<div class="conclusion-summary"><p>';
            html += `<strong>ê°€ì¥ ë‹¤ì–‘:</strong> ${mostDiverse[0].column} (${mostDiverse[0].diversity}ê°œ) `;
            html += `/ <strong>ê°€ì¥ ì§‘ì¤‘:</strong> ${leastDiverse[0].column} (${leastDiverse[0].diversity}ê°œ)`;
            html += '</p></div>';
            
            html += '<div class="conclusion-actions"><h6>ğŸ’¡ ì‹¤í–‰ ì „ëµ</h6><ul>';
            html += `<li><strong>ì§‘ì¤‘ ë©”íƒ€ë°ì´í„°(${leastDiverse.map(d => d.column).slice(0, 2).join(', ')})</strong>: ê²€ì¦ëœ íŒ¨í„´ ê·¸ëŒ€ë¡œ ë”°ë¥´ê¸°</li>`;
            html += `<li><strong>ë‹¤ì–‘ ë©”íƒ€ë°ì´í„°(${mostDiverse.map(d => d.column).slice(0, 2).join(', ')})</strong>: ì°¨ë³„í™” í¬ì¸íŠ¸ë¡œ í™œìš©</li>`;
            html += `<li>íˆíŠ¸ë§µ ë°ì€ ìƒ‰ = ë¯¸ê°œì²™ í‹ˆìƒˆ ê¸°íšŒ</li>`;
            html += '</ul></div>';
            
            return html;
        }

        function createHeatmap() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            ).slice(0, 8); // ìµœëŒ€ 8ê°œ

            const matrix = [];
            const labels = [];
            const diversityData = [];

            columns.forEach(col => {
                const freq = calculateFrequency(col);
                const topValues = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 5);
                const uniqueCount = Object.keys(freq).length;
                
                diversityData.push({ column: col, diversity: uniqueCount });
                
                topValues.forEach(([value, count]) => {
                    labels.push(`${col}: ${value}`);
                    matrix.push(count);
                });
            });

            const ctx = document.getElementById('heatmapChart');
            if (!ctx) return diversityData;

            // ë°”ì°¨íŠ¸ë¡œ íˆíŠ¸ë§µ ëŒ€ì²´ (ë” ëª…í™•í•¨)
            charts['heatmapChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë¹ˆë„',
                        data: matrix,
                        backgroundColor: matrix.map(val => {
                            const intensity = val / Math.max(...matrix);
                            return `rgba(74, 144, 226, ${0.3 + intensity * 0.7})`;
                        }),
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            return diversityData;
        }

        function createRadarChart() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            ).slice(0, 6);

            // ê° ì»¬ëŸ¼ì˜ "ë‹¤ì–‘ì„±"ì„ ì¸¡ì • (ê³ ìœ ê°’ ê°œìˆ˜)
            const data = columns.map(col => {
                const freq = calculateFrequency(col);
                return Object.keys(freq).length; // ê³ ìœ ê°’ì˜ ê°œìˆ˜
            });

            const ctx = document.getElementById('radarChart');
            if (!ctx) return;

            charts['radarChart'] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: columns,
                    datasets: [{
                        label: 'ê³ ìœ ê°’ ê°œìˆ˜ (ë‹¤ì–‘ì„±)',
                        data: data,
                        backgroundColor: 'rgba(74, 144, 226, 0.2)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(74, 144, 226, 1)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ë“¤
        function downloadFrequencyResults() {
            let text = '=== ê¸°ë³¸ ë¹ˆë„ ë¶„ì„ ê²°ê³¼ ===\n\n';
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );

            columns.forEach(col => {
                const freq = calculateFrequency(col);
                text += `\n[${col}]\n`;
                Object.entries(freq).sort((a, b) => b[1] - a[1]).forEach(([key, val]) => {
                    text += `  ${key}: ${val}ê°œ (${((val/currentData.length)*100).toFixed(1)}%)\n`;
                });
            });

            downloadTextFile('ë¹ˆë„ë¶„ì„_ê²°ê³¼.txt', text);
        }

        function downloadCombinationResults() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            const combinations = findTopCombinations(columns, 2);

            let text = '=== ì¡°í•© íŒ¨í„´ ë¶„ì„ ê²°ê³¼ ===\n\n';
            combinations.forEach((combo, idx) => {
                text += `${idx + 1}. ${combo.pattern}: ${combo.count}íšŒ\n`;
            });

            downloadTextFile('ì¡°í•©ë¶„ì„_ê²°ê³¼.txt', text);
        }

        function downloadAssociationResults() {
            const rules = calculateAssociationRules();

            let text = '=== ì—°ê´€ ê·œì¹™ ë¶„ì„ ê²°ê³¼ ===\n\n';
            rules.forEach((rule, idx) => {
                text += `${idx + 1}. ${rule.rule}\n`;
                text += `   ì‹ ë¢°ë„: ${(rule.confidence * 100).toFixed(1)}%, ì§€ì§€ë„: ${(rule.support * 100).toFixed(1)}%\n\n`;
            });

            downloadTextFile('ì—°ê´€ê·œì¹™_ê²°ê³¼.txt', text);
        }

        function downloadVisualResults() {
            alert('ì‹œê°í™” ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ë ¤ë©´ ì°¨íŠ¸ë¥¼ ìš°í´ë¦­í•˜ì—¬ "ì´ë¯¸ì§€ë¡œ ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”.');
        }

        function downloadTextFile(filename, text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
