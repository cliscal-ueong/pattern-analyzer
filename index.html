<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”íƒ€ë°ì´í„° íŒ¨í„´ ë¶„ì„ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(74, 144, 226, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            background: #F5FBFF;
            border: 3px dashed #4A90E2;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-section:hover {
            background: #E3F2FD;
            border-color: #1565C0;
        }

        .upload-section.dragover {
            background: #BBDEFB;
            border-color: #0D47A1;
        }

        .upload-icon {
            font-size: 4em;
            color: #4A90E2;
            margin-bottom: 20px;
        }

        .upload-section h3 {
            color: #1565C0;
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .upload-section p {
            color: #666;
            font-size: 1em;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #81D4FA 0%, #4FC3F7 100%);
        }

        .data-preview {
            margin-bottom: 30px;
            display: none;
        }

        .data-preview-header {
            cursor: pointer;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .data-preview-header:hover {
            background: linear-gradient(135deg, #BBDEFB 0%, #90CAF9 100%);
        }

        .data-preview-header h3 {
            color: #1565C0;
            font-size: 1.3em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            padding: 15px 25px;
            border-radius: 10px;
            border-left: 4px solid #4A90E2;
        }

        .stat-box strong {
            color: #1565C0;
            font-size: 1.1em;
        }

        .preview-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .preview-content.open {
            max-height: 500px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #BBDEFB;
            max-height: 300px;
            overflow-y: auto;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        thead {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #E3F2FD;
            font-size: 0.9em;
            white-space: nowrap;
            min-width: 80px;
        }

        td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #E3F2FD;
            font-size: 0.85em;
            white-space: nowrap;
        }

        tbody tr:hover {
            background: #F5FBFF;
        }

        tbody tr:nth-child(even) {
            background: #FAFAFA;
        }

        .analysis-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: white;
            color: #4A90E2;
            border: 2px solid #4A90E2;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
        }

        .tab-btn:hover {
            background: #E3F2FD;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
            border-color: #4A90E2;
        }

        .analysis-section {
            display: none;
        }

        .analysis-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .explanation-box {
            background: linear-gradient(135deg, #F5FBFF 0%, #E3F2FD 100%);
            border-left: 4px solid #4A90E2;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .explanation-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .explanation-toggle h4 {
            color: #1565C0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-icon {
            color: #4A90E2;
            font-size: 1.5em;
            transition: transform 0.3s;
        }

        .toggle-icon.open {
            transform: rotate(180deg);
        }

        .explanation-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .explanation-content.open {
            max-height: 500px;
            margin-top: 15px;
        }

        .explanation-content p {
            color: #444;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .explanation-content ul {
            margin-left: 20px;
            color: #444;
            line-height: 1.8;
        }

        .result-box {
            background: white;
            border: 1px solid #BBDEFB;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .result-box h4 {
            color: #1565C0;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-box {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4A90E2;
        }

        .summary-box h5 {
            color: #0D47A1;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .summary-box ul {
            list-style: none;
            padding: 0;
        }

        .summary-box li {
            color: #1565C0;
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
        }

        .summary-box li:before {
            content: "â—";
            color: #4A90E2;
            font-size: 1.2em;
            position: absolute;
            left: 0;
        }

        .conclusion-box {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CC 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #FFA726;
        }

        .conclusion-box h5 {
            color: #E65100;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conclusion-summary {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid #FFA726;
        }

        .conclusion-summary p {
            color: #333;
            line-height: 1.8;
            margin: 0;
            font-size: 1.05em;
            font-weight: 500;
        }

        .conclusion-actions {
            margin-top: 15px;
        }

        .conclusion-actions h6 {
            color: #E65100;
            font-size: 1em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .conclusion-actions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .conclusion-actions li {
            color: #444;
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
        }

        .conclusion-actions li:before {
            content: "â–¸";
            color: #FFA726;
            font-size: 1.2em;
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .chart-grid-item {
            background: white;
            border: 1px solid #BBDEFB;
            border-radius: 10px;
            padding: 12px;
        }

        .chart-grid-item h5 {
            color: #1565C0;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-align: center;
        }

        .chart-grid-item canvas {
            max-height: 150px !important;
            height: 150px !important;
        }

        .charts-toggle-section {
            margin-bottom: 20px;
        }

        .charts-toggle-btn {
            width: 100%;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            color: #1565C0;
            font-weight: 600;
            transition: all 0.3s;
        }

        .charts-toggle-btn:hover {
            background: linear-gradient(135deg, #BBDEFB 0%, #90CAF9 100%);
        }

        .charts-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .charts-content.open {
            max-height: 3000px;
            margin-top: 20px;
            overflow-y: auto;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .ai-section {
            background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
            border-left: 5px solid #9C27B0;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .ai-enhance-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #AB47BC 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
            width: 100%;
            margin-top: 15px;
        }

        .ai-enhance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }

        .ai-enhance-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .ai-result {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #9C27B0;
            line-height: 1.8;
        }

        .ai-result h6 {
            color: #9C27B0;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E1BEE7;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #9C27B0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-config-section {
            background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
            border-left: 5px solid #9C27B0;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .api-config-section h4 {
            color: #9C27B0;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #9C27B0;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s;
        }

        .api-input:focus {
            border-color: #7B1FA2;
            box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.1);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-indicator.active {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .download-section {
            text-align: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px dashed #BBDEFB;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .download-section button {
            min-width: 180px;
        }

        .insight-toggle {
            cursor: pointer;
        }

        .insight-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .insight-content.open {
            max-height: 1000px;
            margin-top: 15px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        /* ê°œì„ ëœ AI ê²°ê³¼ ìŠ¤íƒ€ì¼ */
        .prime-analysis-result {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #9C27B0;
            box-shadow: 0 4px 20px rgba(156, 39, 176, 0.1);
        }

        .prime-analysis-result h2 {
            color: #9C27B0;
            font-size: 1.5em;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #E1BEE7;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ ìœ„ê³„ ìŠ¤íƒ€ì¼ */
        .analysis-h2 {
            color: #7B1FA2;
            font-size: 1.6em;
            font-weight: 700;
            margin-top: 35px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #E1BEE7;
            line-height: 1.4;
        }

        .analysis-h3 {
            color: #8E24AA;
            font-size: 1.35em;
            font-weight: 600;
            margin-top: 28px;
            margin-bottom: 16px;
            padding-left: 15px;
            border-left: 5px solid #9C27B0;
            line-height: 1.4;
        }

        .analysis-h4 {
            color: #9C27B0;
            font-size: 1.15em;
            font-weight: 600;
            margin-top: 22px;
            margin-bottom: 14px;
            padding-left: 12px;
            border-left: 3px solid #BA68C8;
            line-height: 1.5;
        }

        .analysis-h5 {
            color: #AB47BC;
            font-size: 1.05em;
            font-weight: 600;
            margin-top: 18px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .analysis-p {
            color: #333;
            font-size: 1.02em;
            line-height: 1.85;
            margin-bottom: 14px;
            text-align: justify;
        }

        /* ê°œì„ ëœ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ - ë“¤ì—¬ì“°ê¸° ê°•í™” */
        .analysis-ul, .analysis-ol {
            margin: 16px 0;
            padding-left: 30px;
        }

        .analysis-ul ul, .analysis-ol ol {
            margin: 8px 0 8px 0;
            padding-left: 30px;  /* 25px â†’ 30px ì¦ê°€ */
        }

        .analysis-ul ul ul, .analysis-ol ol ol {
            margin: 6px 0 6px 0;
            padding-left: 25px;
        }

        .analysis-li {
            color: #444;
            font-size: 1.0em;
            line-height: 1.85;
            margin-bottom: 10px;
            padding-left: 8px;
            position: relative;
        }

        .analysis-ul > .analysis-li {
            list-style-type: disc;
            color: #9C27B0;
        }

        .analysis-ul > .analysis-li::marker {
            content: "â— ";
            color: #9C27B0;
            font-size: 1.1em;
        }

        .analysis-ol > .analysis-li {
            list-style-type: decimal;
        }

        .analysis-ol > .analysis-li::marker {
            color: #9C27B0;
            font-weight: 700;
        }

        /* ì¤‘ì²© ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ë³€ê²½ - ë” ëª…í™•í•˜ê²Œ */
        .analysis-ul ul > .analysis-li::marker {
            content: "â—‹ ";
            color: #BA68C8;
            font-size: 1.0em;
        }

        .analysis-ul ul ul > .analysis-li::marker {
            content: "â–ª ";
            color: #CE93D8;
            font-size: 0.9em;
        }

        .prime-analysis-result strong {
            color: #9C27B0;
            font-weight: 600;
        }

        .prime-highlight-box {
            background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #9C27B0;
        }

        .prime-strategy-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #E1BEE7;
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.1);
        }

        .prime-strategy-card h5 {
            color: #9C27B0;
            font-size: 1.05em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* íŒŒì¼ ê´€ë¦¬ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .file-management-section {
            background: white;
            border: 2px solid #BBDEFB;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .file-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #E3F2FD;
        }

        .file-management-header h3 {
            color: #1565C0;
            font-size: 1.3em;
            margin: 0;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-item {
            background: linear-gradient(135deg, #F5FBFF 0%, #E3F2FD 100%);
            border: 1px solid #BBDEFB;
            border-radius: 10px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .file-item:hover {
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.15);
        }

        .file-item.active {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border: 2px solid #4A90E2;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .file-icon {
            font-size: 2em;
        }

        .file-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .file-name {
            color: #1565C0;
            font-weight: 600;
            font-size: 1.05em;
        }

        .file-meta {
            color: #666;
            font-size: 0.85em;
            display: flex;
            gap: 15px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-btn-select {
            background: linear-gradient(135deg, #4A90E2 0%, #5CA7F7 100%);
            color: white;
        }

        .file-btn-select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .file-btn-delete {
            background: linear-gradient(135deg, #EF5350 0%, #E53935 100%);
            color: white;
        }

        .file-btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 83, 80, 0.3);
        }

        .file-status-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }

            .upload-section {
                padding: 30px 20px;
            }

            .analysis-tabs {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-grid-item canvas {
                max-height: 200px !important;
                height: 200px !important;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .file-actions {
                width: 100%;
            }

            .file-btn {
                flex: 1;
            }

            .file-management-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .file-management-header button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ë©”íƒ€ë°ì´í„° íŒ¨í„´ ë¶„ì„ê¸°</h1>
            <p>ìƒí’ˆ ë©”íƒ€ë°ì´í„°ì˜ ìˆ¨ê²¨ì§„ íŒ¨í„´ì„ ë°œê²¬í•˜ì„¸ìš”</p>
        </div>

        <div class="content">
            <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“</div>
                <h3>ì—‘ì…€ ë˜ëŠ” CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
                <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
            </div>

            <!-- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
            <div class="data-preview" id="dataPreview">
                <div class="data-preview-header" onclick="toggleDataPreview()">
                    <h3>ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
                    <span class="toggle-icon" id="previewToggleIcon">â–¼</span>
                </div>
                <div class="preview-content" id="previewContent">
                    <div class="data-stats" id="dataStats"></div>
                    <div class="table-container" id="tableContainer"></div>
                </div>
            </div>

            <!-- ì—…ë¡œë“œëœ íŒŒì¼ ê´€ë¦¬ -->
            <div class="file-management-section" id="fileManagementSection" style="display: none;">
                <div class="file-management-header">
                    <h3>ğŸ“‚ ì—…ë¡œë“œëœ íŒŒì¼ ê´€ë¦¬</h3>
                    <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" style="font-size: 0.9em; padding: 8px 20px;">
                        â• íŒŒì¼ ì¶”ê°€
                    </button>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <!-- Gemini API ì„¤ì • -->
            <div class="api-config-section" id="apiConfigSection" style="display: none;">
                <h4>ğŸ¤– AI ë¶„ì„ í–¥ìƒ</h4>
                
                <!-- API ì…ë ¥ ì˜ì—­ -->
                <div id="apiInputArea">
                    <div class="api-input-group">
                        <input type="password" 
                               class="api-input" 
                               id="geminiApiKey" 
                               placeholder="Gemini API í‚¤ ì…ë ¥ (ì˜ˆ: AIzaSy...)"
                               onchange="saveApiKey()">
                        <button class="btn btn-secondary" onclick="saveApiKey()" style="white-space: nowrap;">
                            ì—°ê²°í•˜ê¸°
                        </button>
                    </div>
                    <p style="color: #666; font-size: 0.85em; margin-top: 10px; line-height: 1.6;">
                        ğŸ’¡ <strong>API í‚¤ ë°œê¸‰ ë°©ë²•:</strong><br>
                        1. <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #9C27B0;">Google AI Studio</a> ì ‘ì†<br>
                        2. "Create API key" í´ë¦­<br>
                        3. í”„ë¡œì íŠ¸ ì„ íƒ ë˜ëŠ” ìƒì„± (ì˜ˆ: pattern-analysis)<br>
                        4. ìƒì„±ëœ API í‚¤ ë³µì‚¬ í›„ ìœ„ì— ì…ë ¥<br>
                        <br>
                        âœ¨ <strong>ë¬´ë£Œ í•œë„:</strong> Gemini 1.5 Flash (ë¶„ë‹¹ 15íšŒ, ì¼ì¼ 1,500íšŒ)<br>
                        ğŸ”’ API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                </div>
                
                <!-- API ìƒíƒœ ì˜ì—­ -->
                <div id="apiStatusArea" style="display: none;">
                    <div class="api-status">
                        <span class="status-indicator active" id="apiStatusIndicator"></span>
                        <span id="apiStatusText" style="color: #4CAF50; font-weight: 600;">API ì—°ê²°ë¨</span>
                        <button class="btn" onclick="disconnectApi()" style="margin-left: auto; font-size: 0.9em; padding: 8px 16px;">
                            ì—°ê²° í•´ì œ
                        </button>
                    </div>
                    <p style="color: #666; font-size: 0.85em; margin-top: 10px;">
                        âœ¨ ê° ë¶„ì„ í˜ì´ì§€ì—ì„œ <strong>"AIë¡œ ë¶„ì„ í–¥ìƒí•˜ê¸°"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                    </p>
                </div>
            </div>

            <!-- ë¶„ì„ íƒ­ -->
            <div class="analysis-tabs" id="analysisTabs" style="display: none;">
                <button class="tab-btn active" data-tab="frequency">ğŸ“ˆ ê¸°ë³¸ ë¹ˆë„ ë¶„ì„</button>
                <button class="tab-btn" data-tab="combination">ğŸ”— ì¡°í•© íŒ¨í„´ ë¶„ì„</button>
                <button class="tab-btn" data-tab="association">ğŸ¯ ì—°ê´€ ê·œì¹™ ë¶„ì„</button>
                <button class="tab-btn" data-tab="visual">ğŸ—ºï¸ ë¹„ì£¼ì–¼ ë§µí•‘</button>
            </div>

            <!-- ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ë“¤ -->
            <div id="analysisResults"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let charts = {};
        let geminiApiKey = localStorage.getItem('geminiApiKey') || '';
        let uploadedFiles = []; // ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡
        let currentFileIndex = 0; // í˜„ì¬ ë¶„ì„ ì¤‘ì¸ íŒŒì¼ ì¸ë±ìŠ¤
        
        // AI ë¶„ì„ ê²°ê³¼ ì €ì¥ì†Œ (íƒ­ ì „í™˜í•´ë„ ìœ ì§€)
        let aiAnalysisCache = {
            frequency: null,
            combination: null,
            association: null,
            visual: null
        };

        // API í‚¤ ì €ì¥ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        async function saveApiKey() {
            const input = document.getElementById('geminiApiKey');
            const apiKey = input.value.trim();
            
            if (!apiKey) {
                alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // API í‚¤ í…ŒìŠ¤íŠ¸
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            const models = ['gemini-2.5-flash', 'gemini-2.0-flash', 'gemini-2.5-pro'];
            let success = false;
            let workingModel = null;
            
            for (const model of models) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: 'ì•ˆë…•'
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 10,
                            }
                        })
                    });

                    if (response.ok) {
                        success = true;
                        workingModel = model;
                        break;
                    }
                } catch (error) {
                    continue;
                }
            }
            
            testBtn.disabled = false;
            testBtn.textContent = originalText;
            
            if (success) {
                // ì„±ê³µ ì‹œ ì €ì¥
                geminiApiKey = apiKey;
                localStorage.setItem('geminiApiKey', geminiApiKey);
                updateApiStatus(true);
                
                // UI ì „í™˜
                document.getElementById('apiInputArea').style.display = 'none';
                document.getElementById('apiStatusArea').style.display = 'block';
                
                alert(`âœ… API ì—°ê²° ì„±ê³µ!\n\nì‚¬ìš© ëª¨ë¸: ${workingModel}\n\nì´ì œ ê° ë¶„ì„ì—ì„œ "AIë¡œ ë¶„ì„ í–¥ìƒí•˜ê¸°" ë²„íŠ¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            } else {
                alert(`âŒ API ì—°ê²° ì‹¤íŒ¨\n\nëª¨ë“  ëª¨ë¸ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. Google Cloud Console (console.cloud.google.com) ì ‘ì†\n2. í”„ë¡œì íŠ¸ ì„ íƒ (pattern-analysis)\n3. "API ë° ì„œë¹„ìŠ¤" â†’ "ë¼ì´ë¸ŒëŸ¬ë¦¬"\n4. "Generative Language API" ê²€ìƒ‰ í›„ í™œì„±í™”\n5. ìƒˆ API í‚¤ ë°œê¸‰ í›„ ì¬ì‹œë„`);
            }
        }

        function disconnectApi() {
            if (confirm('API ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                geminiApiKey = '';
                localStorage.removeItem('geminiApiKey');
                document.getElementById('geminiApiKey').value = '';
                
                // UI ì „í™˜
                document.getElementById('apiInputArea').style.display = 'block';
                document.getElementById('apiStatusArea').style.display = 'none';
                
                updateApiStatus(false);
            }
        }

        function updateApiStatus(isActive) {
            const indicator = document.getElementById('apiStatusIndicator');
            const text = document.getElementById('apiStatusText');
            
            if (isActive) {
                indicator.classList.add('active');
                text.textContent = 'API ì—°ê²°ë¨';
                text.style.color = '#4CAF50';
            } else {
                indicator.classList.remove('active');
                text.textContent = 'API ë¯¸ì—°ê²°';
                text.style.color = '#666';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ API í‚¤ ë³µì›
        window.addEventListener('load', () => {
            if (geminiApiKey) {
                document.getElementById('geminiApiKey').value = geminiApiKey;
                document.getElementById('apiInputArea').style.display = 'none';
                document.getElementById('apiStatusArea').style.display = 'block';
                updateApiStatus(true);
            }
        });

        // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í† ê¸€
        function toggleDataPreview() {
            const content = document.getElementById('previewContent');
            const icon = document.getElementById('previewToggleIcon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // Gemini API í˜¸ì¶œ (ì—¬ëŸ¬ ëª¨ë¸ ì‹œë„)
        async function callGeminiAPI(prompt) {
            if (!geminiApiKey) {
                alert('Gemini API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return null;
            }

            // ì‹œë„í•  ëª¨ë¸ ëª©ë¡ (2025ë…„ ìµœì‹  ëª¨ë¸)
            const models = [
                'gemini-2.5-flash',
                'gemini-2.0-flash',
                'gemini-2.5-pro'
            ];

            let lastError = null;

            for (const model of models) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.3,  // 0.7 â†’ 0.3 (ì¼ê´€ì„± í–¥ìƒ)
                                maxOutputTokens: 8000,  // 3000 â†’ 8000 (ëŠê¹€ ë°©ì§€)
                            }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        if (!data.candidates || !data.candidates[0]) {
                            throw new Error('API ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        }
                        
                        return data.candidates[0].content.parts[0].text;
                    }

                    lastError = await response.json().catch(() => ({}));
                    
                } catch (error) {
                    lastError = error;
                    continue; // ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                }
            }

            // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨
            console.error('ëª¨ë“  ëª¨ë¸ ì‹œë„ ì‹¤íŒ¨:', lastError);
            alert(`AI ë¶„ì„ ì˜¤ë¥˜\n\nëª¨ë“  ëª¨ë¸ ì—°ê²° ì‹¤íŒ¨. API ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\ní•´ê²° ë°©ë²•:\n1. Google AI Studioì—ì„œ "Generative Language API" í™œì„±í™”\n2. API í‚¤ ì¬ìƒì„±\n3. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸`);
            return null;
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // íŒŒì¼ ì •ë³´ ì €ì¥
                    const fileInfo = {
                        name: file.name,
                        size: file.size,
                        uploadTime: new Date().toLocaleString('ko-KR'),
                        data: jsonData,
                        rowCount: jsonData.length,
                        columnCount: Object.keys(jsonData[0] || {}).length
                    };
                    
                    uploadedFiles.push(fileInfo);
                    currentFileIndex = uploadedFiles.length - 1;
                    currentData = jsonData;
                    
                    // UI ì—…ë°ì´íŠ¸
                    updateFileList();
                    displayDataPreview(jsonData);
                    initializeAnalysis();
                    
                    // íŒŒì¼ ê´€ë¦¬ ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('fileManagementSection').style.display = 'block';
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateFileList() {
            const fileListDiv = document.getElementById('fileList');
            
            if (uploadedFiles.length === 0) {
                fileListDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            fileListDiv.innerHTML = '';
            
            uploadedFiles.forEach((file, index) => {
                const isActive = index === currentFileIndex;
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${isActive ? 'active' : ''}`;
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">ğŸ“Š</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">
                                <span>ğŸ“¦ ${file.rowCount}í–‰ Ã— ${file.columnCount}ì—´</span>
                                <span>ğŸ“… ${file.uploadTime}</span>
                                <span>ğŸ’¾ ${formatFileSize(file.size)}</span>
                            </div>
                        </div>
                        ${isActive ? '<span class="file-status-badge">ë¶„ì„ ì¤‘</span>' : ''}
                    </div>
                    <div class="file-actions">
                        ${!isActive ? `<button class="file-btn file-btn-select" onclick="selectFile(${index})">ì„ íƒ</button>` : ''}
                        <button class="file-btn file-btn-delete" onclick="deleteFile(${index})">ì‚­ì œ</button>
                    </div>
                `;
                
                fileListDiv.appendChild(fileItem);
            });
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // íŒŒì¼ ì„ íƒ
        function selectFile(index) {
            if (index < 0 || index >= uploadedFiles.length) return;
            
            currentFileIndex = index;
            currentData = uploadedFiles[index].data;
            
            // UI ì—…ë°ì´íŠ¸
            updateFileList();
            displayDataPreview(currentData);
            
            // ë¶„ì„ ì´ˆê¸°í™”
            document.getElementById('analysisTabs').style.display = 'flex';
            showAnalysis('frequency');
            
            // ì•Œë¦¼
            alert(`"${uploadedFiles[index].name}" íŒŒì¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // íŒŒì¼ ì‚­ì œ
        function deleteFile(index) {
            if (index < 0 || index >= uploadedFiles.length) return;
            
            const fileName = uploadedFiles[index].name;
            
            if (!confirm(`"${fileName}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            // íŒŒì¼ ì‚­ì œ
            uploadedFiles.splice(index, 1);
            
            // í˜„ì¬ íŒŒì¼ ì¸ë±ìŠ¤ ì¡°ì •
            if (uploadedFiles.length === 0) {
                // ëª¨ë“  íŒŒì¼ ì‚­ì œë¨
                currentFileIndex = 0;
                currentData = null;
                
                // UI ì´ˆê¸°í™”
                document.getElementById('fileManagementSection').style.display = 'none';
                document.getElementById('dataPreview').style.display = 'none';
                document.getElementById('apiConfigSection').style.display = 'none';
                document.getElementById('analysisTabs').style.display = 'none';
                document.getElementById('analysisResults').innerHTML = '';
                
                alert('ëª¨ë“  íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                // ë‹¤ë¥¸ íŒŒì¼ì´ ë‚¨ì•„ìˆìŒ
                if (index === currentFileIndex) {
                    // ì‚­ì œëœ íŒŒì¼ì´ í˜„ì¬ ì„ íƒëœ íŒŒì¼ì¸ ê²½ìš°
                    currentFileIndex = Math.max(0, index - 1);
                    currentData = uploadedFiles[currentFileIndex].data;
                    
                    displayDataPreview(currentData);
                    showAnalysis('frequency');
                    
                    alert(`"${fileName}" íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n"${uploadedFiles[currentFileIndex].name}" íŒŒì¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.`);
                } else if (index < currentFileIndex) {
                    // ì‚­ì œëœ íŒŒì¼ì´ í˜„ì¬ íŒŒì¼ë³´ë‹¤ ì•ì— ìˆëŠ” ê²½ìš°
                    currentFileIndex--;
                }
                
                updateFileList();
            }
        }

        function displayDataPreview(data) {
            const previewSection = document.getElementById('dataPreview');
            const statsDiv = document.getElementById('dataStats');
            const tableDiv = document.getElementById('tableContainer');

            // í†µê³„ í‘œì‹œ
            const columns = Object.keys(data[0]);
            statsDiv.innerHTML = `
                <div class="stat-box">
                    <strong>${data.length}</strong> ê°œì˜ ìƒí’ˆ
                </div>
                <div class="stat-box">
                    <strong>${columns.length}</strong> ê°œì˜ ë©”íƒ€ë°ì´í„°
                </div>
            `;

            // í…Œì´ë¸” ìƒì„± (ìƒìœ„ 10ê°œë§Œ)
            const previewData = data.slice(0, 10);
            let tableHTML = '<table><thead><tr>';
            columns.forEach(col => {
                tableHTML += `<th>${col}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            previewData.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(col => {
                    tableHTML += `<td>${row[col] || '-'}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';

            tableDiv.innerHTML = tableHTML;
            previewSection.style.display = 'block';
            
            // API ì„¤ì • ì„¹ì…˜ í‘œì‹œ
            document.getElementById('apiConfigSection').style.display = 'block';
        }

        function initializeAnalysis() {
            document.getElementById('analysisTabs').style.display = 'flex';
            
            // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const tab = btn.dataset.tab;
                    showAnalysis(tab);
                });
            });

            // ì²« ë²ˆì§¸ ë¶„ì„ í‘œì‹œ
            showAnalysis('frequency');
        }

        function showAnalysis(type) {
            const resultsDiv = document.getElementById('analysisResults');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            switch(type) {
                case 'frequency':
                    resultsDiv.innerHTML = generateFrequencyAnalysis();
                    break;
                case 'combination':
                    resultsDiv.innerHTML = generateCombinationAnalysis();
                    break;
                case 'association':
                    resultsDiv.innerHTML = generateAssociationAnalysis();
                    break;
                case 'visual':
                    resultsDiv.innerHTML = generateVisualMapping();
                    break;
            }

            // í† ê¸€ ì´ë²¤íŠ¸ ì¶”ê°€
            document.querySelectorAll('.explanation-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.toggle-icon');
                    content.classList.toggle('open');
                    icon.classList.toggle('open');
                });
            });
        }

        // ë¹ˆë„ ê³„ì‚° í•¨ìˆ˜
        function calculateFrequency(column) {
            const freq = {};
            currentData.forEach(row => {
                const value = row[column];
                freq[value] = (freq[value] || 0) + 1;
            });
            return freq;
        }

        // ===== í†µì¼ëœ í”„ë¡¬í”„íŠ¸ êµ¬ì¡° ìƒìˆ˜ =====
        const UNIFIED_PROMPT_STRUCTURE = `
## ğŸš¨ ì‘ì„± ê·œì¹™ (ì ˆëŒ€ ê·œì¹™ - 100% ì¤€ìˆ˜!)

**ë§ˆí¬ë‹¤ìš´ í˜•ì‹ í•„ìˆ˜:**
- ëŒ€ì œëª©: ## (H2)
- ì¤‘ì œëª©: ### (H3)
- ì†Œì œëª©: #### (H4)
- ê°•ì¡°: **í…ìŠ¤íŠ¸**
- ë¦¬ìŠ¤íŠ¸: - ì‚¬ìš© (ë°˜ë“œì‹œ!)
- **ğŸš¨ í•˜ìœ„ í•­ëª©ì€ ë°˜ë“œì‹œ ì •í™•íˆ ê³µë°± 2ê°œë¡œ ë“¤ì—¬ì“°ê¸°!**

**ë“¤ì—¬ì“°ê¸° ì˜ˆì‹œ (ì •í™•íˆ ì´ë ‡ê²Œ!):**

#### ë°œê²¬ 1: ì œëª©
- **ì™œ ì¤‘ìš”í•œê°€ìš”?**
  - ìƒìœ„ 10ê°œ ì¤‘ 70%ê°€ ìºë¦­í„° ê¸°ë°˜ì…ë‹ˆë‹¤ (ê³µë°± 2ê°œ!)
  - 70%ê°€ ê·€ì—¬ìš´ ì„±ê²©ì„ ê°€ì§€ë©° 80%ê°€ ì •ì  ì½˜í…ì¸ ì…ë‹ˆë‹¤ (ê³µë°± 2ê°œ!)
- **ì–´ë–»ê²Œ í™œìš©í•˜ë‚˜ìš”?**
  - ìºë¦­í„°ë¥¼ ì „ë©´ì— ë°°ì¹˜í•˜ì„¸ìš” (ê³µë°± 2ê°œ!)
  - ì •ì  ì½˜í…ì¸ ë¡œ ì•ˆì •ê°ì„ ì£¼ì„¸ìš” (ê³µë°± 2ê°œ!)

**í†¤ & ìŠ¤íƒ€ì¼:**
- 20~30ëŒ€ í¬ë¦¬ì—ì´í„° íƒ€ê²Ÿ
- ì¹œê·¼í•œ ë‰´ìŠ¤ë ˆí„° ìŠ¤íƒ€ì¼
- ì§§ì€ ë¬¸ë‹¨ (2~4ì¤„)
- ì´ëª¨ì§€ ì ê·¹ í™œìš©

**ğŸš¨ ì ˆëŒ€ ê·œì¹™:**
1. ëª¨ë“  ì„¹ì…˜ì„ ë°˜ë“œì‹œ ì™„ì„±í•˜ì„¸ìš” (ì ˆëŒ€ ì¤‘ê°„ì— ëŠìœ¼ë©´ ì•ˆë¨!)
2. í•˜ìœ„ í•­ëª©ì€ ì •í™•íˆ ê³µë°± 2ê°œë¡œ ë“¤ì—¬ì“°ê¸°
3. ìš”ì²­í•œ ê°œìˆ˜ë§Œí¼ ì •í™•íˆ ì‘ì„± (TOP 3ì´ë©´ 3ê°œ, TOP 5ë©´ 5ê°œ)
4. ê° í•­ëª©ë§ˆë‹¤ êµ¬ì²´ì ì¸ ìˆ«ìì™€ ì˜ˆì‹œ í¬í•¨
`;

        // ===== ê°œì„ ëœ AI ë¶„ì„ í•¨ìˆ˜ë“¤ (í†µì¼ëœ êµ¬ì¡°) =====

        async function enhanceFrequencyWithAI() {
            const btn = document.getElementById('frequencyAiBtn');
            const resultDiv = document.getElementById('frequencyAiResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>ë¶„ì„ ì¤‘... (30ì´ˆ~1ë¶„ ì†Œìš”)';
            
            // ë°ì´í„° ì¤€ë¹„
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            
            let analysisData = '## ë¶„ì„ ë°ì´í„°\n\n';
            columns.forEach(col => {
                const freq = calculateFrequency(col);
                const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]);
                analysisData += `### ${col}\n`;
                sorted.slice(0, 5).forEach(([key, val]) => {
                    analysisData += `- ${key}: ${val}ê°œ (${((val/currentData.length)*100).toFixed(1)}%)\n`;
                });
                analysisData += `- ì´ ${Object.keys(freq).length}ê°œì˜ ê³ ìœ ê°’\n\n`;
            });

            const prompt = `# ë¹ˆë„ ë¶„ì„ ê³¼ì œ

ì•„ë˜ëŠ” ìƒìœ„ 10ê°œ ìƒí’ˆì˜ ë©”íƒ€ë°ì´í„° ë¹ˆë„ ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤:

${analysisData}

ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ **ì‹¤ë¬´ì—ì„œ ë°”ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ì½˜í…ì¸  ì œì‘ ì „ëµ**ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

${UNIFIED_PROMPT_STRUCTURE}

## í•„ìˆ˜ í¬í•¨ ì„¹ì…˜ (ì •í™•íˆ ì´ êµ¬ì¡°ë¡œ!)

### ğŸ¯ í•µì‹¬ ìš”ì•½
ì „ì²´ ë¶„ì„ì˜ ê°€ì¥ ì¤‘ìš”í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ 3~5ì¤„ë¡œ ìš”ì•½

### ğŸ”¥ ì£¼ìš” ë°œê²¬ TOP 3 (ì •í™•íˆ 3ê°œ!)

ê° ë°œê²¬ë§ˆë‹¤ ì•„ë˜ êµ¬ì¡° ì‚¬ìš©:

#### ë°œê²¬ 1: [ì œëª©]
- **ì™œ ì¤‘ìš”í•œê°€ìš”?**
  - ë°ì´í„° ê·¼ê±° ì„¤ëª… (ê³µë°± 2ê°œ!)
  - êµ¬ì²´ì  ìˆ˜ì¹˜ í¬í•¨ (ê³µë°± 2ê°œ!)
- **ì–´ë–»ê²Œ í™œìš©í•˜ë‚˜ìš”?**
  - ì‹¤ì „ ì ìš© ë°©ë²• 1 (ê³µë°± 2ê°œ!)
  - ì‹¤ì „ ì ìš© ë°©ë²• 2 (ê³µë°± 2ê°œ!)
- **ì£¼ì˜í•  ì **
  - í•¨ì •/ì‹¤ìˆ˜ ë°©ì§€ íŒ (ê³µë°± 2ê°œ!)

#### ë°œê²¬ 2: [ì œëª©]
(ë™ì¼í•œ êµ¬ì¡°ë¡œ)

#### ë°œê²¬ 3: [ì œëª©]
(ë™ì¼í•œ êµ¬ì¡°ë¡œ)

### ğŸ’¡ ì‹¤í–‰ ì „ëµ

#### ì§€ê¸ˆ ë‹¹ì¥ í•´ì•¼ í•  ê²ƒ âœ…
- ì‹¤í–‰ í•­ëª© 1
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)
- ì‹¤í–‰ í•­ëª© 2
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)

#### ì ˆëŒ€ í”¼í•´ì•¼ í•  ê²ƒ âš ï¸
- í”¼í•  íŒ¨í„´ 1
  - ì´ìœ  (ê³µë°± 2ê°œ!)
- í”¼í•  íŒ¨í„´ 2
  - ì´ìœ  (ê³µë°± 2ê°œ!)

### ğŸ“ˆ 3ë‹¨ê³„ ì‹¤í–‰ í”Œëœ

#### 1ë‹¨ê³„: ì˜¤ëŠ˜ ë°”ë¡œ (30ë¶„ ì´ë‚´)
- ì¦‰ì‹œ ì‹¤í–‰ í•­ëª© 1
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)
- ì¦‰ì‹œ ì‹¤í–‰ í•­ëª© 2
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)

#### 2ë‹¨ê³„: ì´ë²ˆ ì£¼ ì•ˆì—
- ë‹¨ê¸° ì‹¤í–‰ í•­ëª© 1
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)
- ë‹¨ê¸° ì‹¤í–‰ í•­ëª© 2
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)

#### 3ë‹¨ê³„: ë‹¤ìŒ ë‹¬ê¹Œì§€
- ì¥ê¸° ì¤€ë¹„ í•­ëª© 1
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)
- ì¥ê¸° ì¤€ë¹„ í•­ëª© 2
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)

ğŸš¨ **ë§¤ìš° ì¤‘ìš”**: 
- ëª¨ë“  ì„¹ì…˜ì„ ë°˜ë“œì‹œ ì™„ì„±í•˜ì„¸ìš”!
- í•˜ìœ„ í•­ëª©ì€ ì •í™•íˆ ê³µë°± 2ê°œë¡œ ë“¤ì—¬ì“°ê¸°!
- TOP 3ì´ë¯€ë¡œ ë°œê²¬ì„ ì •í™•íˆ 3ê°œ ì‘ì„±!

ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

            const result = await callGeminiAPI(prompt);
            
            if (result) {
                const formattedResult = `<div class="prime-analysis-result">${formatMarkdown(result)}</div>`;
                
                // ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥
                aiAnalysisCache.frequency = formattedResult;
                
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = formattedResult;
                
                // ê²°ë¡  ë°•ìŠ¤ ì—…ë°ì´íŠ¸
                document.getElementById('frequencyConclusion').innerHTML = generateFrequencyConclusion();
            }
            
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
        }

        async function enhanceCombinationWithAI() {
            const btn = document.getElementById('combinationAiBtn');
            const resultDiv = document.getElementById('combinationAiResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>ë¶„ì„ ì¤‘...';
            
            // ë°ì´í„° ì¤€ë¹„
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            const combinations = findTopCombinations(columns, 2);
            
            let analysisData = '## ì¡°í•© íŒ¨í„´ ë°ì´í„°\n\n';
            combinations.slice(0, 15).forEach((combo, idx) => {
                analysisData += `${idx + 1}. ${combo.pattern}: ${combo.count}íšŒ (${((combo.count/currentData.length)*100).toFixed(1)}%)\n`;
            });

            const prompt = `# ë°ì´í„° ë¶„ì„ ê³¼ì œ

ì•„ë˜ëŠ” ìƒìœ„ 10ê°œ ìƒí’ˆì˜ **ë©”íƒ€ë°ì´í„° ì¡°í•© íŒ¨í„´** ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤:

${analysisData}

ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ **ì‹¤ë¬´ì—ì„œ ë°”ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ì½˜í…ì¸  ì œì‘ ì „ëµ**ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

## ì‘ì„± ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)

**ë§ˆí¬ë‹¤ìš´ í˜•ì‹:**
- ëŒ€ì œëª©: ## (H2)
- ì¤‘ì œëª©: ### (H3)
- ì†Œì œëª©: #### (H4)
- ê°•ì¡°: **í…ìŠ¤íŠ¸**
- ë¦¬ìŠ¤íŠ¸: - ë˜ëŠ” 1. ì‚¬ìš©
- **ë“¤ì—¬ì“°ê¸°: í•˜ìœ„ í•­ëª©ì€ ë°˜ë“œì‹œ ê³µë°± 2ê°œë¡œ ë“¤ì—¬ì“°ê¸°!**

**êµ¬ì¡° ì˜ˆì‹œ:**

### ì œëª©
- ìƒìœ„ í•­ëª©
  - í•˜ìœ„ ìƒì„¸ 1 (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
  - í•˜ìœ„ ìƒì„¸ 2


**í†¤ & ìŠ¤íƒ€ì¼:**
- 20ëŒ€ ë‰´ìŠ¤ë ˆí„° ìŠ¤íƒ€ì¼
- ì§§ì€ ë¬¸ë‹¨ (2~4ì¤„)
- ì´ëª¨ì§€ ì ê·¹ í™œìš©

## í•„ìˆ˜ í¬í•¨ ì„¹ì…˜ (ì•„ë˜ êµ¬ì¡° ì •í™•íˆ ë”°ë¥´ê¸°)

### ğŸ”— ì¡°í•© íŒ¨í„´ í•µì‹¬ ìš”ì•½
(TOP 3 ì¡°í•©ì„ ì†Œê°œí•˜ê³  ì™œ ìì£¼ ë‚˜íƒ€ë‚˜ëŠ”ì§€ 3~4ì¤„ ì„¤ëª…)

### ğŸ¯ ì„±ê³µ ì¡°í•© ë¶„ì„ (ìµœì†Œ 3ê°œ)

ê° ì¡°í•©ë§ˆë‹¤ ì•„ë˜ êµ¬ì¡° ì‚¬ìš©:

#### ì¡°í•© 1: [ì¡°í•© ì´ë¦„]
- **ì™œ ì„±ê³µí–ˆë‚˜ìš”?**
  - ì„±ê³µ ì´ìœ  ë¶„ì„ (2~3ì¤„)
  - ë°ì´í„° ê·¼ê±°
- **ëˆ„êµ¬ì—ê²Œ íš¨ê³¼ì ì¸ê°€ìš”?**
  - íƒ€ê²Ÿ ê³ ê°ê³¼ ë‹ˆì¦ˆ (2~3ì¤„)
- **ì–´ë–»ê²Œ ì ìš©í•˜ì£ ?**
  - êµ¬ì²´ì  ì ìš© ë°©ë²• (2~3ì¤„)
  - ì‹¤ì „ ì˜ˆì‹œ

### âš ï¸ í”¼í•´ì•¼ í•  ì¡°í•©
- ì‹¤íŒ¨ ì¡°í•© 1
  - ì™œ ì•ˆ ì¢‹ì€ì§€ ì´ìœ 
- ì‹¤íŒ¨ ì¡°í•© 2
  - ì™œ ì•ˆ ì¢‹ì€ì§€ ì´ìœ 

### ğŸ’¡ ì¡°í•© í™œìš© ì „ëµ

#### ê²€ì¦ëœ ì¡°í•© ë”°ë¼í•˜ê¸°
- ì•ˆì „í•œ ë°©ë²• 1
  - êµ¬ì²´ì  ì„¤ëª…
- ì•ˆì „í•œ ë°©ë²• 2
  - êµ¬ì²´ì  ì„¤ëª…

#### ìƒˆë¡œìš´ ì¡°í•© ì‹¤í—˜í•˜ê¸°
- í…ŒìŠ¤íŠ¸ ë°©ë²• 1
  - A/B í…ŒìŠ¤íŠ¸ ì•„ì´ë””ì–´
- í…ŒìŠ¤íŠ¸ ë°©ë²• 2
  - ë¦¬ìŠ¤í¬ ê´€ë¦¬

### ğŸ“ˆ 3ë‹¨ê³„ ì‹¤í–‰ í”Œëœ

#### 1ë‹¨ê³„: ì˜¤ëŠ˜ ë°”ë¡œ
- ì¦‰ì‹œ ì‹¤í–‰ í•­ëª©

#### 2ë‹¨ê³„: ì´ë²ˆ ì£¼ ì•ˆì—
- ë‹¨ê¸° ì‹¤í–‰ í•­ëª©

#### 3ë‹¨ê³„: ë‹¤ìŒ ë‹¬ê¹Œì§€
- ì¥ê¸° ì¤€ë¹„ í•­ëª©

**ì¤‘ìš”: ëª¨ë“  í•˜ìœ„ í•­ëª©ì€ ë°˜ë“œì‹œ ê³µë°± 2ê°œë¡œ ë“¤ì—¬ì“°ê¸° í•˜ì„¸ìš”!**
ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

            const result = await callGeminiAPI(prompt);
            
            if (result) {
                const formattedResult = `<div class="prime-analysis-result">${formatMarkdown(result)}</div>`;
                aiAnalysisCache.combination = formattedResult;
                
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = formattedResult;
                
                document.getElementById('combinationConclusion').innerHTML = generateCombinationConclusion(combinations);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
        }

        async function enhanceAssociationWithAI() {
            const btn = document.getElementById('associationAiBtn');
            const resultDiv = document.getElementById('associationAiResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>ë¶„ì„ ì¤‘...';
            
            const rules = calculateAssociationRules();
            
            let analysisData = '## ì—°ê´€ ê·œì¹™ ë°ì´í„°\n\n';
            rules.slice(0, 10).forEach((rule, idx) => {
                analysisData += `${idx + 1}. ${rule.rule}\n`;
                analysisData += `   - ì‹ ë¢°ë„: ${(rule.confidence * 100).toFixed(1)}% (Aê°€ ìˆìœ¼ë©´ Bê°€ ìˆì„ í™•ë¥ )\n`;
                analysisData += `   - ì§€ì§€ë„: ${(rule.support * 100).toFixed(1)}% (ì „ì²´ ì¤‘ Aì™€ Bê°€ í•¨ê»˜ ë‚˜íƒ€ë‚˜ëŠ” ë¹„ìœ¨)\n\n`;
            });

            const prompt = `# ë°ì´í„° ë¶„ì„ ê³¼ì œ

ì•„ë˜ëŠ” ìƒìœ„ 10ê°œ ìƒí’ˆì˜ **ë©”íƒ€ë°ì´í„° ì—°ê´€ ê·œì¹™** ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤:

${analysisData}

**ì—°ê´€ ê·œì¹™ì´ë€?** "Aë¥¼ ì„ íƒí•˜ë©´ â†’ Bë„ í•¨ê»˜ ì„ íƒëœë‹¤"ëŠ” íŒ¨í„´ì´ì—ìš”.
- **ì‹ ë¢°ë„**: Aê°€ ìˆì„ ë•Œ Bê°€ ë‚˜íƒ€ë‚  í™•ë¥  (ë†’ì„ìˆ˜ë¡ ê°•ë ¥)
- **ì§€ì§€ë„**: ì „ì²´ì—ì„œ A+Bê°€ í•¨ê»˜ ë‚˜íƒ€ë‚˜ëŠ” ë¹„ìœ¨

ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ **ì‹¤ë¬´ì—ì„œ ë°”ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ì „ëµ**ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

## ğŸš¨ ì‘ì„± ê·œì¹™ (ì ˆëŒ€ ê·œì¹™ - ë°˜ë“œì‹œ ë”°ë¥´ê¸°!)

**ë§ˆí¬ë‹¤ìš´ í˜•ì‹ í•„ìˆ˜:**
- ëŒ€ì œëª©: ## (H2)
- ì¤‘ì œëª©: ### (H3)
- ì†Œì œëª©: #### (H4)
- ê°•ì¡°: **í…ìŠ¤íŠ¸**
- ë¦¬ìŠ¤íŠ¸: - ì‚¬ìš©
- **ğŸš¨ í•˜ìœ„ í•­ëª©ì€ ë°˜ë“œì‹œ ì•ì— ê³µë°± 2ê°œ ë„£ê¸°!**

**ë“¤ì—¬ì“°ê¸° ì˜ˆì‹œ (ì •í™•íˆ ì´ë ‡ê²Œ!):**

#### ê·œì¹™ 1: í…ìŠ¤íŠ¸ í¬í•¨ "ì •ì¹˜í˜•" â†’ ì½˜í…ì¸  ìœ í˜•="ì •ì¹˜í˜•"
- **ì™œ ê°•ë ¥í•œê°€ìš”?**
  - ì‹ ë¢°ë„ 100%, ì§€ì§€ë„ 70%ë¡œ ë§¤ìš° ê°•ë ¥í•œ ê·œì¹™ì…ë‹ˆë‹¤
  - í…ìŠ¤íŠ¸ì— ì •ì¹˜í˜•ì´ ë“¤ì–´ê°€ë©´ ì½˜í…ì¸  ìœ í˜•ë„ ì •ì¹˜í˜•ì¼ í™•ë¥ ì´ 100%
- **ì‹¤ì „ í™œìš©ë²•**
  - ì œëª©ì— ì •ì¹˜ í‚¤ì›Œë“œ ì‚¬ìš©ì‹œ ì½˜í…ì¸  ìœ í˜•ì„ ì •ì¹˜í˜•ìœ¼ë¡œ ì„¤ì •
  - íƒ€ê²Ÿ ë…ìë¥¼ ì •ì¹˜ ê´€ì‹¬ì¸µìœ¼ë¡œ ëª…í™•íˆ ì„¤ì •
- **ì˜ˆìƒ ê²°ê³¼**
  - í´ë¦­ë¥  30% í–¥ìƒ ì˜ˆìƒ


**ğŸš¨ ìœ„ ì˜ˆì‹œì²˜ëŸ¼ í•˜ìœ„ ë‚´ìš©ì€ ë°˜ë“œì‹œ ê³µë°± 2ê°œë¡œ ë“¤ì—¬ì“°ê¸°!**

**í†¤ & ìŠ¤íƒ€ì¼:**
- 20ëŒ€ ë‰´ìŠ¤ë ˆí„° ìŠ¤íƒ€ì¼
- ì§§ì€ ë¬¸ë‹¨ (2~4ì¤„)
- ì´ëª¨ì§€ ì ê·¹ í™œìš©

## í•„ìˆ˜ í¬í•¨ ì„¹ì…˜ (ì •í™•íˆ ì´ êµ¬ì¡°ë¡œ!)

### ğŸ¯ ê°•ë ¥í•œ ê·œì¹™ TOP 3
(ê° ê·œì¹™ì„ ì†Œê°œí•˜ê³  ì‹ ë¢°ë„ê°€ ì˜ë¯¸í•˜ëŠ” ê²ƒì„ 2~3ì¤„ë¡œ ì„¤ëª…)

### ğŸ’ ê·œì¹™ë³„ ê¹Šì´ ë¶„ì„ (ìµœì†Œ 3ê°œ)

ğŸš¨ ê° ê·œì¹™ë§ˆë‹¤ ì•„ë˜ êµ¬ì¡°ë¥¼ ì •í™•íˆ ì‚¬ìš©í•˜ì„¸ìš”:

#### ê·œì¹™ 1: [ì‹¤ì œ ê·œì¹™ ë‚´ìš©]
- **ì™œ ê°•ë ¥í•œê°€ìš”?**
  - ì²« ë²ˆì§¸ ì´ìœ  (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
  - ë‘ ë²ˆì§¸ ì´ìœ  (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
- **ì‹¤ì „ í™œìš©ë²•**
  - ì ìš© ë°©ë²• 1 (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
  - ì ìš© ë°©ë²• 2 (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
- **ì˜ˆìƒ ê²°ê³¼**
  - ê¸°ëŒ€ íš¨ê³¼ (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)

#### ê·œì¹™ 2: [ì‹¤ì œ ê·œì¹™ ë‚´ìš©]
- **ì™œ ê°•ë ¥í•œê°€ìš”?**
  - ì²« ë²ˆì§¸ ì´ìœ  (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
  - ë‘ ë²ˆì§¸ ì´ìœ  (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
- **ì‹¤ì „ í™œìš©ë²•**
  - ì ìš© ë°©ë²• 1 (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
  - ì ìš© ë°©ë²• 2 (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
- **ì˜ˆìƒ ê²°ê³¼**
  - ê¸°ëŒ€ íš¨ê³¼ (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)

#### ê·œì¹™ 3: [ì‹¤ì œ ê·œì¹™ ë‚´ìš©]
- **ì™œ ê°•ë ¥í•œê°€ìš”?**
  - ì²« ë²ˆì§¸ ì´ìœ  (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
  - ë‘ ë²ˆì§¸ ì´ìœ  (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
- **ì‹¤ì „ í™œìš©ë²•**
  - ì ìš© ë°©ë²• 1 (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
  - ì ìš© ë°©ë²• 2 (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
- **ì˜ˆìƒ ê²°ê³¼**
  - ê¸°ëŒ€ íš¨ê³¼ (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)

### ğŸ“‹ í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- Aë¥¼ ì„ íƒí–ˆë‹¤ë©´ â†’ Bë„ ë„£ìœ¼ì„¸ìš”
  - ì´ìœ  ì„¤ëª… (ê³µë°± 2ê°œ!)
- Cë¥¼ ì„ íƒí–ˆë‹¤ë©´ â†’ Dë„ ë„£ìœ¼ì„¸ìš”
  - ì´ìœ  ì„¤ëª… (ê³µë°± 2ê°œ!)
- Eë¥¼ ì„ íƒí–ˆë‹¤ë©´ â†’ Fë„ ë„£ìœ¼ì„¸ìš”
  - ì´ìœ  ì„¤ëª… (ê³µë°± 2ê°œ!)

### âš ï¸ ì£¼ì˜ì‚¬í•­
- ë‚®ì€ ì‹ ë¢°ë„ ê·œì¹™ ë‹¤ë£¨ëŠ” ë²•
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)
- ë°ì´í„° ì ì„ ë•Œ ì£¼ì˜ì 
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)
- í”í•œ ì‹¤ìˆ˜ë“¤
  - ì˜ˆë°© ë°©ë²• (ê³µë°± 2ê°œ!)

### ğŸ’¡ ì½˜í…ì¸  ì œì‘ ê°€ì´ë“œ

#### ê·œì¹™ ê¸°ë°˜ êµ¬ì„±ë²•
- ë°©ë²• 1
  - êµ¬ì²´ì  ì„¤ëª… (ê³µë°± 2ê°œ!)
- ë°©ë²• 2
  - êµ¬ì²´ì  ì„¤ëª… (ê³µë°± 2ê°œ!)

### ğŸ“ˆ 3ë‹¨ê³„ ì‹¤í–‰ í”Œëœ

#### 1ë‹¨ê³„: ì˜¤ëŠ˜ ë°”ë¡œ
- ì¦‰ì‹œ ì‹¤í–‰ í•­ëª©
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)

#### 2ë‹¨ê³„: ì´ë²ˆ ì£¼ ì•ˆì—
- ë‹¨ê¸° ì‹¤í–‰ í•­ëª©
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)

#### 3ë‹¨ê³„: ë‹¤ìŒ ë‹¬ê¹Œì§€
- ì¥ê¸° ì¤€ë¹„ í•­ëª©
  - êµ¬ì²´ì  ë°©ë²• (ê³µë°± 2ê°œ!)

ğŸš¨ğŸš¨ğŸš¨ ì ˆëŒ€ ê·œì¹™: ëª¨ë“  í•˜ìœ„ ìƒì„¸ ë‚´ìš© ì•ì—ëŠ” ê³µë°± 2ê°œë¥¼ ë°˜ë“œì‹œ ë„£ìœ¼ì„¸ìš”! ğŸš¨ğŸš¨ğŸš¨
ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

            const result = await callGeminiAPI(prompt);
            
            if (result) {
                const formattedResult = `<div class="prime-analysis-result">${formatMarkdown(result)}</div>`;
                aiAnalysisCache.association = formattedResult;
                
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = formattedResult;
                
                document.getElementById('associationConclusion').innerHTML = generateAssociationConclusion(rules);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
        }

        async function enhanceVisualWithAI() {
            const btn = document.getElementById('visualAiBtn');
            const resultDiv = document.getElementById('visualAiResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>ë¶„ì„ ì¤‘...';
            
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            
            let analysisData = '## ë©”íƒ€ë°ì´í„° ë‹¤ì–‘ì„± ë¶„ì„\n\n';
            columns.forEach(col => {
                const freq = calculateFrequency(col);
                const uniqueCount = Object.keys(freq).length;
                analysisData += `- ${col}: ${uniqueCount}ê°œì˜ ê³ ìœ ê°’ (ë‹¤ì–‘ì„± ì§€ìˆ˜)\n`;
            });

            const prompt = `# ë°ì´í„° ë¶„ì„ ê³¼ì œ

ì•„ë˜ëŠ” ìƒìœ„ 10ê°œ ìƒí’ˆì˜ **ë©”íƒ€ë°ì´í„° ë‹¤ì–‘ì„±** ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤:

${analysisData}

**ë‹¤ì–‘ì„± ì§€ìˆ˜ë€?** ê° ë©”íƒ€ë°ì´í„°ê°€ ì–¼ë§ˆë‚˜ ë‹¤ì–‘í•œ ê°’ì„ ê°€ì§€ëŠ”ì§€ ë³´ì—¬ì£¼ëŠ” ìˆ«ìì˜ˆìš”.
- **ë†’ì€ ë‹¤ì–‘ì„±** = ì„ íƒì§€ ë§ìŒ = ì°¨ë³„í™” ê¸°íšŒ ë§ìŒ
- **ë‚®ì€ ë‹¤ì–‘ì„±** = ì„ íƒì§€ ì ìŒ = ì´ë¯¸ ê²€ì¦ëœ ì„±ê³µ ê³µì‹

ì´ ë°ì´í„°ë¡œ **ì‹¤ì „ì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì „ëµ**ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

## ì‘ì„± ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)

**ë§ˆí¬ë‹¤ìš´ í˜•ì‹:**
- ëŒ€ì œëª©: ## (H2)
- ì¤‘ì œëª©: ### (H3)
- ì†Œì œëª©: #### (H4)
- ê°•ì¡°: **í…ìŠ¤íŠ¸**
- ë¦¬ìŠ¤íŠ¸: - ë˜ëŠ” 1. ì‚¬ìš©
- **ë“¤ì—¬ì“°ê¸°: í•˜ìœ„ í•­ëª©ì€ ë°˜ë“œì‹œ ê³µë°± 2ê°œë¡œ ë“¤ì—¬ì“°ê¸°!**

**êµ¬ì¡° ì˜ˆì‹œ:**

### ì œëª©
- ìƒìœ„ í•­ëª©
  - í•˜ìœ„ ìƒì„¸ 1 (ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!)
  - í•˜ìœ„ ìƒì„¸ 2


**í†¤ & ìŠ¤íƒ€ì¼:**
- 20ëŒ€ ë‰´ìŠ¤ë ˆí„° ìŠ¤íƒ€ì¼
- ì§§ì€ ë¬¸ë‹¨ (2~4ì¤„)
- ì´ëª¨ì§€ ì ê·¹ í™œìš©

## í•„ìˆ˜ í¬í•¨ ì„¹ì…˜ (ì•„ë˜ êµ¬ì¡° ì •í™•íˆ ë”°ë¥´ê¸°)

### ğŸ—ºï¸ ë‹¤ì–‘ì„± ì§€ë„ ì½ê¸°

#### ê°€ì¥ ë‹¤ì–‘í•œ ê²ƒë“¤ TOP 3
- í•­ëª© 1 (Nê°œ ê³ ìœ ê°’)
  - ì™œ ë‹¤ì–‘í•œì§€ (2~3ì¤„)
  - ì˜ë¯¸í•˜ëŠ” ê²ƒ
- í•­ëª© 2 (Nê°œ ê³ ìœ ê°’)
  - ì™œ ë‹¤ì–‘í•œì§€
  - ì˜ë¯¸í•˜ëŠ” ê²ƒ
- í•­ëª© 3 (Nê°œ ê³ ìœ ê°’)
  - ì™œ ë‹¤ì–‘í•œì§€
  - ì˜ë¯¸í•˜ëŠ” ê²ƒ

#### ê°€ì¥ ì§‘ì¤‘ëœ ê²ƒë“¤ TOP 3
- í•­ëª© 1 (Nê°œ ê³ ìœ ê°’)
  - ì™œ ì§‘ì¤‘ëëŠ”ì§€ (2~3ì¤„)
  - ì˜ë¯¸í•˜ëŠ” ê²ƒ
- í•­ëª© 2 (Nê°œ ê³ ìœ ê°’)
  - ì™œ ì§‘ì¤‘ëëŠ”ì§€
  - ì˜ë¯¸í•˜ëŠ” ê²ƒ
- í•­ëª© 3 (Nê°œ ê³ ìœ ê°’)
  - ì™œ ì§‘ì¤‘ëëŠ”ì§€
  - ì˜ë¯¸í•˜ëŠ” ê²ƒ

### ğŸ’ ë‹¤ì–‘ì„±ìœ¼ë¡œ ì°¨ë³„í™”í•˜ê¸°

#### ë†’ì€ ë‹¤ì–‘ì„± í™œìš©ë²•
- í‹ˆìƒˆ ì‹œì¥ ê³µëµ
  - êµ¬ì²´ì  ë°©ë²• (2~3ì¤„)
  - ì˜ˆì‹œ
- ìƒˆë¡œìš´ ì¡°í•© ì‹¤í—˜
  - í…ŒìŠ¤íŠ¸ ì•„ì´ë””ì–´ (2~3ì¤„)
  - ë¦¬ìŠ¤í¬ ê´€ë¦¬
- ì‹¤ì „ ì ìš© ì‚¬ë¡€
  - êµ¬ì²´ì  ì˜ˆì‹œ (2~3ì¤„)

### âœ… ê²€ì¦ëœ íŒ¨í„´ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ

#### ë‚®ì€ ë‹¤ì–‘ì„± í™œìš©ë²•
- ì„±ê³µ íŒ¨í„´ ë”°ë¼í•˜ê¸°
  - ì–´ë–¤ íŒ¨í„´ì„ ì–´ë–»ê²Œ (2~3ì¤„)
  - ì²´í¬ë¦¬ìŠ¤íŠ¸
- ë¦¬ìŠ¤í¬ ì¤„ì´ëŠ” ì „ëµ
  - ì•ˆì „í•˜ê²Œ ê°€ëŠ” ë²• (2~3ì¤„)
  - ì£¼ì˜ì‚¬í•­

### ğŸ“Š ê· í˜• ì¡íŒ ì½˜í…ì¸  ì „ëµ

#### ìµœì  ë¹„ìœ¨ ì œì•ˆ
- ì§‘ì¤‘ ë©”íƒ€ë°ì´í„° (ì•ˆì •ì„±): 60%
  - ì´ìœ  (1~2ì¤„)
- ë‹¤ì–‘ ë©”íƒ€ë°ì´í„° (ì°¨ë³„ì„±): 40%
  - ì´ìœ  (1~2ì¤„)

### ğŸ’¡ ë‹¨ê³„ë³„ ì‹¤ì „ ì „ëµ

#### ì‹œì¥ ì§„ì… ì´ˆê¸° (ì•ˆì • ìš°ì„ )
- ë¹„ìœ¨: ê²€ì¦ëœ ê²ƒ 80% + ì‹¤í—˜ 20%
- ì´ìœ 
  - ì„¤ëª… (2~3ì¤„)
- êµ¬ì²´ì  ë°©ë²•
  - ì‹¤í–‰ë²•

#### ì„±ì¥ ë‹¨ê³„ (ê· í˜•)
- ë¹„ìœ¨: 50:50
- ì´ìœ 
  - ì„¤ëª… (2~3ì¤„)
- êµ¬ì²´ì  ë°©ë²•
  - ì‹¤í–‰ë²•

#### ì°¨ë³„í™” ë‹¨ê³„ (ì‹¤í—˜ ìš°ì„ )
- ë¹„ìœ¨: ì‹¤í—˜ 70% + ì•ˆì • 30%
- ì´ìœ 
  - ì„¤ëª… (2~3ì¤„)
- êµ¬ì²´ì  ë°©ë²•
  - ì‹¤í–‰ë²•

### ğŸ“ˆ 3ë‹¨ê³„ ì‹¤í–‰ í”Œëœ

#### 1ë‹¨ê³„: ì˜¤ëŠ˜ ë°”ë¡œ
- ì¦‰ì‹œ ì‹¤í–‰ í•­ëª©

#### 2ë‹¨ê³„: ì´ë²ˆ ì£¼ ì•ˆì—
- ë‹¨ê¸° ì‹¤í–‰ í•­ëª©

#### 3ë‹¨ê³„: ë‹¤ìŒ ë‹¬ê¹Œì§€
- ì¥ê¸° ì¤€ë¹„ í•­ëª©

**ì¤‘ìš”: ëª¨ë“  í•˜ìœ„ í•­ëª©ì€ ë°˜ë“œì‹œ ê³µë°± 2ê°œë¡œ ë“¤ì—¬ì“°ê¸° í•˜ì„¸ìš”!**
ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

            const result = await callGeminiAPI(prompt);
            
            if (result) {
                const formattedResult = `<div class="prime-analysis-result">${formatMarkdown(result)}</div>`;
                aiAnalysisCache.visual = formattedResult;
                
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = formattedResult;
                
                document.getElementById('visualConclusion').innerHTML = generateVisualConclusion([]);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
        }

        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ê°œì„  ë²„ì „)
        function formatMarkdown(text) {
            // 1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ì§€ì‹œë¬¸ ì œê±°
            text = removePromptInstructions(text);
            
            // 2ë‹¨ê³„: ë¦¬ìŠ¤íŠ¸ ë¨¼ì € ì²˜ë¦¬ (ë‹¤ë¥¸ ë³€í™˜ ì „ì—)
            text = parseMarkdownLists(text);
            
            // 3ë‹¨ê³„: í—¤ë”©ê³¼ Bold ì²˜ë¦¬
            text = text
                // H2 (ëŒ€ì œëª©)
                .replace(/^##\s+(.+)$/gim, '<h2 class="analysis-h2">$1</h2>')
                // H3 (ì¤‘ì œëª©)
                .replace(/^###\s+(.+)$/gim, '<h3 class="analysis-h3">$1</h3>')
                // H4 (ì†Œì œëª©)
                .replace(/^####\s+(.+)$/gim, '<h4 class="analysis-h4">$1</h4>')
                // H5 (ë” ì‘ì€ ì œëª©)
                .replace(/^#####\s+(.+)$/gim, '<h5 class="analysis-h5">$1</h5>')
                // Bold
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // 4ë‹¨ê³„: ë‹¨ë½ ì²˜ë¦¬
            const lines = text.split('\n');
            let html = [];
            let inBlock = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // ë¹ˆ ì¤„
                if (!line) {
                    html.push('');
                    inBlock = false;
                    continue;
                }
                
                // ì´ë¯¸ íƒœê·¸ë¡œ ê°ì‹¸ì§„ ì¤„ (í—¤ë”©, ë¦¬ìŠ¤íŠ¸ ë“±)
                if (line.startsWith('<h') || 
                    line.startsWith('<ul') || 
                    line.startsWith('</ul') ||
                    line.startsWith('<ol') || 
                    line.startsWith('</ol') ||
                    line.startsWith('<li')) {
                    html.push(line);
                    inBlock = (line.startsWith('<ul') || line.startsWith('<ol'));
                } else if (!inBlock) {
                    // ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” p íƒœê·¸ë¡œ
                    html.push('<p class="analysis-p">' + line + '</p>');
                } else {
                    html.push(line);
                }
            }
            
            return html.join('\n');
        }

        // í”„ë¡¬í”„íŠ¸ ì§€ì‹œë¬¸ ì œê±° í•¨ìˆ˜
        function removePromptInstructions(text) {
            // ì œê±°í•  íŒ¨í„´ë“¤
            const removePatterns = [
                /ë‹¹ì‹ ì€.{0,100}ë°ì´í„° ë¶„ì„ê°€.{0,200}ì…ë‹ˆë‹¤\./gi,
                /í•˜ë²„ë“œ.{0,50}íŒ”ë€í‹°ì–´.{0,100}/gi,
                /## ì‘ì„± ê°€ì´ë“œë¼ì¸[\s\S]*?(?=##[^#]|$)/gi,
                /### \d+\..{0,50}ê°€ì´ë“œë¼ì¸[\s\S]*?(?=###|##|$)/gi,
                /ë°˜ë“œì‹œ.{0,30}ë§ˆí¬ë‹¤ìš´.{0,50}í˜•ì‹.{0,100}/gi,
                /\*\*í•„ìˆ˜ í¬í•¨ ì„¹ì…˜\*\*[\s\S]*?(?=##|$)/gi,
                /ì´ëª¨ì§€ë¥¼.{0,50}í™œìš©.{0,50}/gi,
                /ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ/gi,
                /ì•„ë˜ëŠ”.{0,50}ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤/gi
            ];
            
            removePatterns.forEach(pattern => {
                text = text.replace(pattern, '');
            });
            
            // ì—°ì†ëœ ë¹ˆ ì¤„ ì •ë¦¬
            text = text.replace(/\n{3,}/g, '\n\n');
            
            return text.trim();
        }

        // ë¦¬ìŠ¤íŠ¸ íŒŒì‹± í•¨ìˆ˜ (ê°œì„  ë²„ì „ - ë“¤ì—¬ì“°ê¸° ê°•í™”)
        function parseMarkdownLists(text) {
            const lines = text.split('\n');
            let result = [];
            let listStack = []; // { type: 'ul'|'ol', level: number }
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                
                // ë¹ˆ ì¤„ ì²˜ë¦¬
                if (!trimmed) {
                    // ëª¨ë“  ì—´ë¦° ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
                    while (listStack.length > 0) {
                        const list = listStack.pop();
                        result.push(list.type === 'ul' ? '</ul>' : '</ol>');
                    }
                    result.push('');
                    continue;
                }
                
                // ë“¤ì—¬ì“°ê¸° ìˆ˜ì¤€ ê³„ì‚° (ê³µë°± 2ê°œ = 1ë ˆë²¨)
                const leadingSpaces = line.match(/^(\s*)/)[1].length;
                const level = Math.floor(leadingSpaces / 2);
                
                // ë¦¬ìŠ¤íŠ¸ í•­ëª© ì²´í¬
                const unorderedMatch = trimmed.match(/^[\-\*]\s+(.+)$/);
                const orderedMatch = trimmed.match(/^\d+\.\s+(.+)$/);
                
                if (unorderedMatch || orderedMatch) {
                    const content = unorderedMatch ? unorderedMatch[1] : orderedMatch[1];
                    const type = unorderedMatch ? 'ul' : 'ol';
                    
                    // ìŠ¤íƒ ì¡°ì •: í˜„ì¬ ë ˆë²¨ë³´ë‹¤ ê¹Šì€ ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
                    while (listStack.length > level) {
                        const list = listStack.pop();
                        result.push(list.type === 'ul' ? '</ul>' : '</ol>');
                    }
                    
                    // ìƒˆë¡œìš´ ë ˆë²¨ ì‹œì‘
                    if (listStack.length < level + 1) {
                        // ì¤‘ê°„ ë ˆë²¨ì´ ë¹„ì–´ìˆìœ¼ë©´ ì±„ìš°ê¸°
                        while (listStack.length < level) {
                            result.push('<ul class="analysis-ul">');
                            listStack.push({ type: 'ul', level: listStack.length });
                        }
                        
                        result.push(type === 'ul' ? '<ul class="analysis-ul">' : '<ol class="analysis-ol">');
                        listStack.push({ type, level });
                    }
                    
                    // ê°™ì€ ë ˆë²¨ì—ì„œ íƒ€ì… ë³€ê²½
                    if (listStack.length > 0) {
                        const currentList = listStack[listStack.length - 1];
                        if (currentList.level === level && currentList.type !== type) {
                            result.push(currentList.type === 'ul' ? '</ul>' : '</ol>');
                            result.push(type === 'ul' ? '<ul class="analysis-ul">' : '<ol class="analysis-ol">');
                            listStack[listStack.length - 1] = { type, level };
                        }
                    }
                    
                    // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€
                    result.push(`<li class="analysis-li">${content}</li>`);
                } else {
                    // ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ì¤„ - ëª¨ë“  ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
                    while (listStack.length > 0) {
                        const list = listStack.pop();
                        result.push(list.type === 'ul' ? '</ul>' : '</ol>');
                    }
                    result.push(line);
                }
            }
            
            // ë§ˆì§€ë§‰ì— ì—´ë¦° ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
            while (listStack.length > 0) {
                const list = listStack.pop();
                result.push(list.type === 'ul' ? '</ul>' : '</ol>');
            }
            
            return result.join('\n');
        }

        // ê¸°ì¡´ ë¶„ì„ ìƒì„± í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        function generateFrequencyAnalysis() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );

            let html = `
                <div class="analysis-section active">
                    <div class="explanation-box">
                        <div class="explanation-toggle">
                            <h4>ğŸ’¡ ê¸°ë³¸ ë¹ˆë„ ë¶„ì„ì´ë€?</h4>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>ë­í•˜ëŠ” ê±°:</strong> ê° ë©”íƒ€ë°ì´í„°ì—ì„œ ì–´ë–¤ ê°’ì´ ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ”ì§€ ì„¸ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
                            <p><strong>ë…¼ë¦¬:</strong> ê°€ì¥ ë§ì´ ë“±ì¥í•˜ëŠ” ê°’ = ê²€ì¦ëœ ì„±ê³µ íŒ¨í„´</p>
                            <p><strong>í™œìš©:</strong> ìƒìœ„ 10ê°œê°€ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” íŠ¹ì„±ì„ ë”°ë¼í•˜ë©´ ì„±ê³µ í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="conclusion-box">
                        <h5>ğŸ“ Prime ì½˜í…ì¸  ë¶„ì„ ê²°ê³¼</h5>
                        <div id="frequencyConclusion">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                            </p>
                        </div>
                        <button class="ai-enhance-btn" onclick="enhanceFrequencyWithAI()" id="frequencyAiBtn">
                            âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                        <div id="frequencyAiResult" style="display: none;"></div>
                    </div>

                    <div class="summary-box">
                        <div class="insight-toggle">
                            <h5 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š í•µì‹¬ ë¶„ì„ ë‚´ìš©</span>
                                <span class="toggle-icon" style="font-size: 1.2em;">â–¼</span>
                            </h5>
                        </div>
                        <div class="insight-content">
                            <ul id="frequencySummary"></ul>
                        </div>
                    </div>

                    <div class="charts-toggle-section">
                        <button class="charts-toggle-btn" onclick="toggleCharts('frequencyCharts')">
                            <span>ğŸ“Š ì°¨íŠ¸ ë³´ê¸°</span>
                            <span class="toggle-icon">â–¼</span>
                        </button>
                        <div class="charts-content" id="frequencyCharts">
                            <div class="chart-grid" id="frequencyChartsGrid"></div>
                        </div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-secondary" onclick="downloadFrequencyResults()">ğŸ“¥ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn" onclick="downloadFrequencyPDF()" style="margin-left: 10px;">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn" onclick="generateComprehensivePlaybook()" style="margin-left: 10px; background: linear-gradient(135deg, #9C27B0 0%, #AB47BC 100%);">ğŸ“˜ ì¢…í•© í”Œë ˆì´ë¶ ìƒì„±</button>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const chartsGrid = document.getElementById('frequencyChartsGrid');
                columns.forEach((col, idx) => {
                    const freq = calculateFrequency(col);
                    const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    
                    const chartItem = document.createElement('div');
                    chartItem.className = 'chart-grid-item';
                    chartItem.innerHTML = `
                        <h5>${col}</h5>
                        <canvas id="freqChart${idx}"></canvas>
                    `;
                    chartsGrid.appendChild(chartItem);

                    const ctx = document.getElementById(`freqChart${idx}`);
                    charts[`freqChart${idx}`] = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: sorted.map(s => s[0]),
                            datasets: [{
                                data: sorted.map(s => s[1]),
                                backgroundColor: [
                                    'rgba(74, 144, 226, 0.8)',
                                    'rgba(92, 167, 247, 0.8)',
                                    'rgba(129, 212, 250, 0.8)',
                                    'rgba(79, 195, 247, 0.8)',
                                    'rgba(144, 202, 249, 0.8)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: { size: 10 }
                                    }
                                }
                            }
                        }
                    });
                });

                // ìš”ì•½ ìƒì„±
                const summaryItems = [`<li>ì´ <strong>${columns.length}ê°œ</strong>ì˜ ë©”íƒ€ë°ì´í„° ë¶„ì„</li>`];
                
                // ê° ì»¬ëŸ¼ë³„ TOP ê°’ ì¶”ê°€
                columns.forEach(col => {
                    const freq = calculateFrequency(col);
                    const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]);
                    const topValue = sorted[0];
                    const topPercent = ((topValue[1] / currentData.length) * 100).toFixed(1);
                    summaryItems.push(`<li><strong>${col}</strong>: "${topValue[0]}" (${topValue[1]}ê°œ, ${topPercent}%)</li>`);
                });
                
                summaryItems.push(`<li>ê° ë©”íƒ€ë°ì´í„°ë³„ ìƒìœ„ 5ê°œ ê°’ì˜ ë¹ˆë„ë¥¼ ì°¨íŠ¸ë¡œ í‘œì‹œ</li>`);
                summaryItems.push(`<li>ê°€ì¥ ë§ì´ ë‚˜íƒ€ë‚˜ëŠ” ê°’ = ê²€ì¦ëœ ì„±ê³µ íŒ¨í„´</li>`);
                
                document.getElementById('frequencySummary').innerHTML = summaryItems.join('');
                
                // ìºì‹œëœ AI ê²°ê³¼ ë³µì›
                if (aiAnalysisCache.frequency) {
                    document.getElementById('frequencyAiResult').style.display = 'block';
                    document.getElementById('frequencyAiResult').innerHTML = aiAnalysisCache.frequency;
                    document.getElementById('frequencyAiBtn').innerHTML = 'âœ¨ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
                    document.getElementById('frequencyConclusion').innerHTML = generateFrequencyConclusion();
                }
                
                // ì¸ì‚¬ì´íŠ¸ í† ê¸€ ì´ë²¤íŠ¸
                const toggleBtn = document.querySelector('#frequencySummary')?.parentElement?.previousElementSibling;
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.toggle-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');
                    });
                }
            }, 100);

            return html;
        }

        function generateFrequencyConclusion() {
            return `<div class="conclusion-summary"><p>AI ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì½˜í…ì¸ ë¥¼ ì œì‘í•˜ì„¸ìš”.</p></div>`;
        }

        function generateCombinationAnalysis() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            const combinations = findTopCombinations(columns, 2);

            let html = `
                <div class="analysis-section active">
                    <div class="explanation-box">
                        <div class="explanation-toggle">
                            <h4>ğŸ’¡ ì¡°í•© íŒ¨í„´ ë¶„ì„ì´ë€?</h4>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>ë­í•˜ëŠ” ê±°:</strong> ë‘ ê°œ ì´ìƒì˜ ë©”íƒ€ë°ì´í„°ê°€ í•¨ê»˜ ë‚˜íƒ€ë‚˜ëŠ” íŒ¨í„´ì„ ì°¾ìŠµë‹ˆë‹¤.</p>
                            <p><strong>ë…¼ë¦¬:</strong> ì„±ê³µí•œ ì½˜í…ì¸ ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” "í™©ê¸ˆ ì¡°í•©"ì„ ë°œê²¬</p>
                            <p><strong>í™œìš©:</strong> ê²€ì¦ëœ ì¡°í•©ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ì‹¤íŒ¨ ë¦¬ìŠ¤í¬ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="conclusion-box">
                        <h5>ğŸ“ Prime ì½˜í…ì¸  ë¶„ì„ ê²°ê³¼</h5>
                        <div id="combinationConclusion">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                            </p>
                        </div>
                        <button class="ai-enhance-btn" onclick="enhanceCombinationWithAI()" id="combinationAiBtn">
                            âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                        <div id="combinationAiResult" style="display: none;"></div>
                    </div>

                    <div class="summary-box">
                        <div class="insight-toggle">
                            <h5 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š í•µì‹¬ ë¶„ì„ ë‚´ìš©</span>
                                <span class="toggle-icon" style="font-size: 1.2em;">â–¼</span>
                            </h5>
                        </div>
                        <div class="insight-content">
                            <ul id="combinationSummary"></ul>
                        </div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ”— ì£¼ìš” ì¡°í•© íŒ¨í„´ (TOP 15)</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ìˆœìœ„</th>
                                        <th>ì¡°í•© íŒ¨í„´</th>
                                        <th>ì¶œí˜„ íšŸìˆ˜</th>
                                        <th>ë¹„ìœ¨</th>
                                    </tr>
                                </thead>
                                <tbody id="combinationTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="charts-toggle-section">
                        <button class="charts-toggle-btn" onclick="toggleCharts('combinationCharts')">
                            <span>ğŸ“Š ì°¨íŠ¸ ë³´ê¸°</span>
                            <span class="toggle-icon">â–¼</span>
                        </button>
                        <div class="charts-content" id="combinationCharts">
                            <div class="chart-container">
                                <canvas id="combinationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-secondary" onclick="downloadCombinationResults()">ğŸ“¥ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn" onclick="downloadCombinationPDF()" style="margin-left: 10px;">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn" onclick="generateComprehensivePlaybook()" style="margin-left: 10px; background: linear-gradient(135deg, #9C27B0 0%, #AB47BC 100%);">ğŸ“˜ ì¢…í•© í”Œë ˆì´ë¶ ìƒì„±</button>
                    </div>
                </div>
            `;

            setTimeout(() => {
                // í…Œì´ë¸” ìƒì„±
                const tableBody = document.getElementById('combinationTable');
                combinations.slice(0, 15).forEach((combo, idx) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${idx + 1}</td>
                        <td style="text-align: left; padding-left: 15px;">${combo.pattern}</td>
                        <td><strong>${combo.count}</strong></td>
                        <td>${((combo.count/currentData.length)*100).toFixed(1)}%</td>
                    `;
                    tableBody.appendChild(row);
                });

                // ì°¨íŠ¸ ìƒì„±
                const ctx = document.getElementById('combinationChart');
                const topCombos = combinations.slice(0, 10);
                charts['combinationChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topCombos.map((c, i) => `ì¡°í•© ${i+1}`),
                        datasets: [{
                            label: 'ì¶œí˜„ íšŸìˆ˜',
                            data: topCombos.map(c => c.count),
                            backgroundColor: 'rgba(74, 144, 226, 0.8)',
                            borderColor: 'rgba(74, 144, 226, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // ìš”ì•½
                const summary = [
                    `<li>ì´ <strong>${combinations.length}ê°œ</strong>ì˜ ì¡°í•© íŒ¨í„´ ë°œê²¬</li>`,
                    `<li>ê°€ì¥ ë§ì€ ì¡°í•©: <strong>${combinations[0].pattern}</strong> (${combinations[0].count}íšŒ)</li>`,
                    `<li>TOP 3 ì¡°í•©ì´ ì „ì²´ì˜ ${((combinations.slice(0,3).reduce((sum, c) => sum + c.count, 0) / currentData.length * 100)).toFixed(1)}% ì°¨ì§€</li>`
                ];
                document.getElementById('combinationSummary').innerHTML = summary.join('');
                
                // ìºì‹œëœ AI ê²°ê³¼ ë³µì›
                if (aiAnalysisCache.combination) {
                    document.getElementById('combinationAiResult').style.display = 'block';
                    document.getElementById('combinationAiResult').innerHTML = aiAnalysisCache.combination;
                    document.getElementById('combinationAiBtn').innerHTML = 'âœ¨ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
                    document.getElementById('combinationConclusion').innerHTML = generateCombinationConclusion(combinations);
                }
                
                // ì¸ì‚¬ì´íŠ¸ í† ê¸€ ì´ë²¤íŠ¸
                const toggleBtn = document.querySelector('#combinationSummary')?.parentElement?.previousElementSibling;
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.toggle-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');
                    });
                }
            }, 100);

            return html;
        }

        function generateCombinationConclusion(combinations) {
            return `<div class="conclusion-summary"><p>AI ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì½˜í…ì¸ ë¥¼ ì œì‘í•˜ì„¸ìš”.</p></div>`;
        }

        function findTopCombinations(columns, size) {
            const combinations = {};
            
            currentData.forEach(row => {
                for (let i = 0; i < columns.length; i++) {
                    for (let j = i + 1; j < columns.length; j++) {
                        const key = `${columns[i]}="${row[columns[i]]}" + ${columns[j]}="${row[columns[j]]}"`;
                        combinations[key] = (combinations[key] || 0) + 1;
                    }
                }
            });

            return Object.entries(combinations)
                .map(([pattern, count]) => ({ pattern, count }))
                .sort((a, b) => b.count - a.count);
        }

        function generateAssociationAnalysis() {
            const rules = calculateAssociationRules();

            let html = `
                <div class="analysis-section active">
                    <div class="explanation-box">
                        <div class="explanation-toggle">
                            <h4>ğŸ’¡ ì—°ê´€ ê·œì¹™ ë¶„ì„ì´ë€?</h4>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>ë­í•˜ëŠ” ê±°:</strong> "Aë¥¼ ì„ íƒí•˜ë©´ â†’ Bë„ í•¨ê»˜ ì„ íƒí•œë‹¤"ëŠ” ê·œì¹™ì„ ì°¾ìŠµë‹ˆë‹¤.</p>
                            <p><strong>ë…¼ë¦¬:</strong> ì‹ ë¢°ë„ê°€ ë†’ì€ ê·œì¹™ = ê°•í•œ ì¸ê³¼ ê´€ê³„</p>
                            <p><strong>í™œìš©:</strong> Aë¥¼ ì •í–ˆë‹¤ë©´ BëŠ” ìë™ìœ¼ë¡œ ë”°ë¼ê°€ì•¼ í•©ë‹ˆë‹¤. ê²€ì¦ëœ ì„¸íŠ¸ ë©”ë‰´ì²˜ëŸ¼ ì‚¬ìš©í•˜ì„¸ìš”.</p>
                        </div>
                    </div>

                    <div class="conclusion-box">
                        <h5>ğŸ“ Prime ì½˜í…ì¸  ë¶„ì„ ê²°ê³¼</h5>
                        <div id="associationConclusion">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                            </p>
                        </div>
                        <button class="ai-enhance-btn" onclick="enhanceAssociationWithAI()" id="associationAiBtn">
                            âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                        <div id="associationAiResult" style="display: none;"></div>
                    </div>

                    <div class="summary-box">
                        <div class="insight-toggle">
                            <h5 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š í•µì‹¬ ë¶„ì„ ë‚´ìš©</span>
                                <span class="toggle-icon" style="font-size: 1.2em;">â–¼</span>
                            </h5>
                        </div>
                        <div class="insight-content">
                            <ul id="associationSummary"></ul>
                        </div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ¯ ê°•ë ¥í•œ ì—°ê´€ ê·œì¹™ (TOP 10)</h4>
                        <div id="rulesTable"></div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-secondary" onclick="downloadAssociationResults()">ğŸ“¥ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn" onclick="downloadAssociationPDF()" style="margin-left: 10px;">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn" onclick="generateComprehensivePlaybook()" style="margin-left: 10px; background: linear-gradient(135deg, #9C27B0 0%, #AB47BC 100%);">ğŸ“˜ ì¢…í•© í”Œë ˆì´ë¶ ìƒì„±</button>
                    </div>
                </div>
            `;

            setTimeout(() => {
                if (rules.length > 0) {
                    // í…Œì´ë¸” ìƒì„±
                    let tableHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ìˆœìœ„</th>
                                        <th>ê·œì¹™ (A â†’ B)</th>
                                        <th>ì‹ ë¢°ë„</th>
                                        <th>ì§€ì§€ë„</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    rules.slice(0, 10).forEach((rule, idx) => {
                        tableHTML += `
                            <tr>
                                <td>${idx + 1}</td>
                                <td style="text-align: left; padding-left: 15px;">${rule.rule}</td>
                                <td><strong>${(rule.confidence * 100).toFixed(1)}%</strong></td>
                                <td>${(rule.support * 100).toFixed(1)}%</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table></div>';
                    document.getElementById('rulesTable').innerHTML = tableHTML;

                    // ìš”ì•½
                    const summary = [
                        `<li>ì´ <strong>${rules.length}ê°œ</strong>ì˜ ì—°ê´€ ê·œì¹™ ë°œê²¬</li>`,
                        `<li>ê°€ì¥ ê°•í•œ ê·œì¹™: <strong>${rules[0].rule}</strong> (ì‹ ë¢°ë„ ${(rules[0].confidence * 100).toFixed(1)}%)</li>`,
                        `<li>í‰ê·  ì‹ ë¢°ë„: ${(rules.reduce((sum, r) => sum + r.confidence, 0) / rules.length * 100).toFixed(1)}%</li>`
                    ];
                    document.getElementById('associationSummary').innerHTML = summary.join('');
                } else {
                    document.getElementById('rulesTable').innerHTML = '<p>ìœ ì˜ë¯¸í•œ ì—°ê´€ ê·œì¹™ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
                
                // ìºì‹œëœ AI ê²°ê³¼ ë³µì›
                if (aiAnalysisCache.association) {
                    document.getElementById('associationAiResult').style.display = 'block';
                    document.getElementById('associationAiResult').innerHTML = aiAnalysisCache.association;
                    document.getElementById('associationAiBtn').innerHTML = 'âœ¨ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
                    document.getElementById('associationConclusion').innerHTML = generateAssociationConclusion(rules);
                }
                
                // ì¸ì‚¬ì´íŠ¸ í† ê¸€ ì´ë²¤íŠ¸
                const toggleBtn = document.querySelector('#associationSummary')?.parentElement?.previousElementSibling;
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.toggle-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');
                    });
                }
            }, 100);

            return html;
        }

        function generateAssociationConclusion(rules) {
            return `<div class="conclusion-summary"><p>AI ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì½˜í…ì¸ ë¥¼ ì œì‘í•˜ì„¸ìš”.</p></div>`;
        }

        function calculateAssociationRules() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            ).slice(0, 5);

            const rules = [];
            const minSupport = 0.2;
            const minConfidence = 0.5;

            for (let i = 0; i < columns.length; i++) {
                for (let j = 0; j < columns.length; j++) {
                    if (i === j) continue;

                    const colA = columns[i];
                    const colB = columns[j];

                    const valuesA = [...new Set(currentData.map(row => row[colA]))];
                    const valuesB = [...new Set(currentData.map(row => row[colB]))];

                    valuesA.forEach(valA => {
                        valuesB.forEach(valB => {
                            const countA = currentData.filter(row => row[colA] === valA).length;
                            const countAB = currentData.filter(row => 
                                row[colA] === valA && row[colB] === valB
                            ).length;

                            const support = countAB / currentData.length;
                            const confidence = countAB / countA;

                            if (support >= minSupport && confidence >= minConfidence) {
                                rules.push({
                                    rule: `${colA}="${valA}" â†’ ${colB}="${valB}"`,
                                    support: support,
                                    confidence: confidence,
                                    lift: confidence / (currentData.filter(row => row[colB] === valB).length / currentData.length)
                                });
                            }
                        });
                    });
                }
            }

            return rules.sort((a, b) => b.confidence - a.confidence);
        }

        function generateVisualMapping() {
            let html = `
                <div class="analysis-section active">
                    <div class="explanation-box">
                        <div class="explanation-toggle">
                            <h4>ğŸ’¡ ë¹„ì£¼ì–¼ ë§µí•‘ì´ë€?</h4>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>ë­í•˜ëŠ” ê±°:</strong> ë©”íƒ€ë°ì´í„° ê°„ì˜ ê´€ê³„ë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.</p>
                            <p><strong>ë…¼ë¦¬:</strong> ë³µì¡í•œ íŒ¨í„´ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ ë„¤íŠ¸ì›Œí¬ í˜•íƒœë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.</p>
                            <p><strong>í™œìš©:</strong> ì–´ë–¤ íŠ¹ì„±ë“¤ì´ ë°€ì ‘í•˜ê²Œ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ ì§ê´€ì ìœ¼ë¡œ ì´í•´</p>
                        </div>
                    </div>

                    <div class="conclusion-box">
                        <h5>ğŸ“ Prime ì½˜í…ì¸  ë¶„ì„ ê²°ê³¼</h5>
                        <div id="visualConclusion">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                            </p>
                        </div>
                        <button class="ai-enhance-btn" onclick="enhanceVisualWithAI()" id="visualAiBtn">
                            âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                        <div id="visualAiResult" style="display: none;"></div>
                    </div>

                    <div class="summary-box">
                        <div class="insight-toggle">
                            <h5 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š í•µì‹¬ ë¶„ì„ ë‚´ìš©</span>
                                <span class="toggle-icon" style="font-size: 1.2em;">â–¼</span>
                            </h5>
                        </div>
                        <div class="insight-content">
                            <ul id="visualSummary"></ul>
                        </div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ—ºï¸ ë©”íƒ€ë°ì´í„° íˆíŠ¸ë§µ</h4>
                        <div class="chart-container" style="height: 600px;">
                            <canvas id="heatmapChart"></canvas>
                        </div>
                    </div>

                    <div class="result-box">
                        <h4>ğŸ“Š íŠ¹ì„±ë³„ ë‹¤ì–‘ì„± ë¹„êµ</h4>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">
                            * ê° ë©”íƒ€ë°ì´í„°ê°€ ì–¼ë§ˆë‚˜ ë‹¤ì–‘í•œ ê°’ì„ ê°€ì§€ëŠ”ì§€ ë³´ì—¬ì¤ë‹ˆë‹¤. ê°’ì´ í´ìˆ˜ë¡ ì„ íƒì§€ê°€ ë‹¤ì–‘í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
                        </p>
                        <div class="chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-secondary" onclick="downloadVisualResults()">ğŸ“¥ ì°¨íŠ¸ ì €ì¥ ì•ˆë‚´</button>
                        <button class="btn" onclick="downloadVisualPDF()" style="margin-left: 10px;">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn" onclick="generateComprehensivePlaybook()" style="margin-left: 10px; background: linear-gradient(135deg, #9C27B0 0%, #AB47BC 100%);">ğŸ“˜ ì¢…í•© í”Œë ˆì´ë¶ ìƒì„±</button>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const diversityData = createHeatmap();
                createRadarChart();

                const columns = Object.keys(currentData[0]).filter(col => 
                    !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
                );

                const summary = [
                    `<li>ì´ <strong>${columns.length}ê°œ</strong>ì˜ ë©”íƒ€ë°ì´í„° ë¶„ì„</li>`,
                    `<li>íˆíŠ¸ë§µ: ì§„í•œ ìƒ‰ìƒ = ë†’ì€ ë¹ˆë„ (ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ê°’)</li>`,
                    `<li>ë ˆì´ë” ì°¨íŠ¸: ê° ë©”íƒ€ë°ì´í„°ì˜ ë‹¤ì–‘ì„± ì¸¡ì • (ê³ ìœ ê°’ ê°œìˆ˜)</li>`,
                    `<li>ë‹¤ì–‘ì„±ì´ ë†’ì€ ë©”íƒ€ë°ì´í„° = ì°¨ë³„í™” í¬ì¸íŠ¸ë¡œ í™œìš© ê°€ëŠ¥</li>`
                ];
                document.getElementById('visualSummary').innerHTML = summary.join('');
                
                // ìºì‹œëœ AI ê²°ê³¼ ë³µì›
                if (aiAnalysisCache.visual) {
                    document.getElementById('visualAiResult').style.display = 'block';
                    document.getElementById('visualAiResult').innerHTML = aiAnalysisCache.visual;
                    document.getElementById('visualAiBtn').innerHTML = 'âœ¨ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
                    document.getElementById('visualConclusion').innerHTML = generateVisualConclusion([]);
                }
                
                // ì¸ì‚¬ì´íŠ¸ í† ê¸€ ì´ë²¤íŠ¸
                const toggleBtn = document.querySelector('#visualSummary')?.parentElement?.previousElementSibling;
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.toggle-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');
                    });
                }
            }, 100);

            return html;
        }

        function generateVisualConclusion(diversityData) {
            return `<div class="conclusion-summary"><p>AI ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì½˜í…ì¸ ë¥¼ ì œì‘í•˜ì„¸ìš”.</p></div>`;
        }

        function createHeatmap() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            ).slice(0, 8);

            const matrix = [];
            const labels = [];
            const diversityData = [];

            columns.forEach(col => {
                const freq = calculateFrequency(col);
                const topValues = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 5);
                const uniqueCount = Object.keys(freq).length;
                
                diversityData.push({ column: col, diversity: uniqueCount });
                
                topValues.forEach(([value, count]) => {
                    labels.push(`${col}: ${value}`);
                    matrix.push(count);
                });
            });

            const ctx = document.getElementById('heatmapChart');
            if (!ctx) return diversityData;

            charts['heatmapChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë¹ˆë„',
                        data: matrix,
                        backgroundColor: matrix.map(val => {
                            const intensity = val / Math.max(...matrix);
                            return `rgba(74, 144, 226, ${0.3 + intensity * 0.7})`;
                        }),
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            return diversityData;
        }

        function createRadarChart() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            ).slice(0, 6);

            const data = columns.map(col => {
                const freq = calculateFrequency(col);
                return Object.keys(freq).length;
            });

            const ctx = document.getElementById('radarChart');
            if (!ctx) return;

            charts['radarChart'] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: columns,
                    datasets: [{
                        label: 'ê³ ìœ ê°’ ê°œìˆ˜ (ë‹¤ì–‘ì„±)',
                        data: data,
                        backgroundColor: 'rgba(74, 144, 226, 0.2)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(74, 144, 226, 1)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ì°¨íŠ¸ í† ê¸€ í•¨ìˆ˜
        function toggleCharts(chartId) {
            const content = document.getElementById(chartId);
            const btn = event.target.closest('.charts-toggle-btn');
            const icon = btn.querySelector('.toggle-icon');
            
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ë“¤
        function downloadFrequencyResults() {
            let text = '=== ê¸°ë³¸ ë¹ˆë„ ë¶„ì„ ê²°ê³¼ ===\n\n';
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );

            columns.forEach(col => {
                const freq = calculateFrequency(col);
                text += `\n[${col}]\n`;
                Object.entries(freq).sort((a, b) => b[1] - a[1]).forEach(([key, val]) => {
                    text += `  ${key}: ${val}ê°œ (${((val/currentData.length)*100).toFixed(1)}%)\n`;
                });
            });

            downloadTextFile('ë¹ˆë„ë¶„ì„_ê²°ê³¼.txt', text);
        }

        function downloadCombinationResults() {
            const columns = Object.keys(currentData[0]).filter(col => 
                !col.includes('ìˆœìœ„') && !col.includes('ID') && !col.includes('ëª…')
            );
            const combinations = findTopCombinations(columns, 2);

            let text = '=== ì¡°í•© íŒ¨í„´ ë¶„ì„ ê²°ê³¼ ===\n\n';
            combinations.forEach((combo, idx) => {
                text += `${idx + 1}. ${combo.pattern}: ${combo.count}íšŒ\n`;
            });

            downloadTextFile('ì¡°í•©ë¶„ì„_ê²°ê³¼.txt', text);
        }

        function downloadAssociationResults() {
            const rules = calculateAssociationRules();

            let text = '=== ì—°ê´€ ê·œì¹™ ë¶„ì„ ê²°ê³¼ ===\n\n';
            rules.forEach((rule, idx) => {
                text += `${idx + 1}. ${rule.rule}\n`;
                text += `   ì‹ ë¢°ë„: ${(rule.confidence * 100).toFixed(1)}%, ì§€ì§€ë„: ${(rule.support * 100).toFixed(1)}%\n\n`;
            });

            downloadTextFile('ì—°ê´€ê·œì¹™_ê²°ê³¼.txt', text);
        }

        function downloadVisualResults() {
            alert('ì‹œê°í™” ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ë ¤ë©´ ì°¨íŠ¸ë¥¼ ìš°í´ë¦­í•˜ì—¬ "ì´ë¯¸ì§€ë¡œ ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”.');
        }

        function downloadTextFile(filename, text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ë“¤ - ëª¨ë‘ í†µí•© PDF ìƒì„±
        async function downloadFrequencyPDF() {
            await downloadAllAnalysisAsPDF();
        }

        async function downloadCombinationPDF() {
            await downloadAllAnalysisAsPDF();
        }

        async function downloadAssociationPDF() {
            await downloadAllAnalysisAsPDF();
        }

        async function downloadVisualPDF() {
            await downloadAllAnalysisAsPDF();
        }

        // í†µí•© PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (html2canvas ì‚¬ìš©)
        async function downloadAllAnalysisAsPDF() {
            try {
                // ë¡œë”© ì•Œë¦¼
                const originalBtn = event.target;
                const originalText = originalBtn.textContent;
                originalBtn.disabled = true;
                originalBtn.textContent = 'ğŸ“„ PDF ìƒì„± ì¤‘... (ëª¨ë“  ë¶„ì„ íƒ­ í†µí•©)';

                // jsPDF ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const today = new Date().toLocaleDateString('ko-KR');
                const fileName = uploadedFiles[currentFileIndex]?.name || 'ë°ì´í„°';
                
                // í‘œì§€ í˜ì´ì§€ HTMLë¡œ ìƒì„±
                const coverDiv = document.createElement('div');
                coverDiv.style.cssText = `
                    width: 794px;
                    height: 1123px;
                    background: white;
                    padding: 60px;
                    font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
                    position: fixed;
                    left: -9999px;
                    top: 0;
                `;
                coverDiv.innerHTML = `
                    <div style="text-align: center; margin-top: 100px;">
                        <h1 style="font-size: 42px; color: #1565C0; margin-bottom: 40px; font-weight: 700;">
                            ğŸ“Š ë©”íƒ€ë°ì´í„° íŒ¨í„´ ë¶„ì„ ë³´ê³ ì„œ
                        </h1>
                        <div style="font-size: 22px; color: #666; margin-bottom: 20px;">
                            <strong>ë¶„ì„ íŒŒì¼:</strong> ${fileName}
                        </div>
                        <div style="font-size: 20px; color: #666; margin-bottom: 60px;">
                            <strong>ìƒì„± ë‚ ì§œ:</strong> ${today}
                        </div>
                        <div style="width: 80%; height: 2px; background: #4A90E2; margin: 60px auto;"></div>
                        <div style="text-align: left; max-width: 500px; margin: 60px auto;">
                            <h2 style="font-size: 26px; color: #1565C0; margin-bottom: 30px;">ğŸ“‹ í¬í•¨ëœ ë¶„ì„</h2>
                            <div style="font-size: 20px; color: #444; line-height: 2.2;">
                                <div style="padding: 12px 0; border-bottom: 1px solid #E3F2FD;">
                                    <strong>1.</strong> ê¸°ë³¸ ë¹ˆë„ ë¶„ì„
                                </div>
                                <div style="padding: 12px 0; border-bottom: 1px solid #E3F2FD;">
                                    <strong>2.</strong> ì¡°í•© íŒ¨í„´ ë¶„ì„
                                </div>
                                <div style="padding: 12px 0; border-bottom: 1px solid #E3F2FD;">
                                    <strong>3.</strong> ì—°ê´€ ê·œì¹™ ë¶„ì„
                                </div>
                                <div style="padding: 12px 0; border-bottom: 1px solid #E3F2FD;">
                                    <strong>4.</strong> ë¹„ì£¼ì–¼ ë§µí•‘ ë¶„ì„
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(coverDiv);
                
                // í‘œì§€ ìº¡ì²˜
                const coverCanvas = await html2canvas(coverDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const coverImgData = coverCanvas.toDataURL('image/png');
                doc.addImage(coverImgData, 'PNG', 0, 0, 210, 297); // A4 ì „ì²´ í¬ê¸°
                
                // í‘œì§€ div ì œê±°
                document.body.removeChild(coverDiv);

                // 4ê°œ ë¶„ì„ íƒ­ ì •ë³´
                const analysisTypes = [
                    { tab: 'frequency', title: 'ê¸°ë³¸ ë¹ˆë„ ë¶„ì„', tabBtn: document.querySelector('[data-tab="frequency"]') },
                    { tab: 'combination', title: 'ì¡°í•© íŒ¨í„´ ë¶„ì„', tabBtn: document.querySelector('[data-tab="combination"]') },
                    { tab: 'association', title: 'ì—°ê´€ ê·œì¹™ ë¶„ì„', tabBtn: document.querySelector('[data-tab="association"]') },
                    { tab: 'visual', title: 'ë¹„ì£¼ì–¼ ë§µí•‘ ë¶„ì„', tabBtn: document.querySelector('[data-tab="visual"]') }
                ];

                // ê° íƒ­ ìˆœíšŒí•˜ë©° ìº¡ì²˜
                for (let i = 0; i < analysisTypes.length; i++) {
                    const analysis = analysisTypes[i];
                    
                    // íƒ­ í™œì„±í™”
                    analysis.tabBtn.click();
                    
                    // DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // ìƒˆ í˜ì´ì§€ ì¶”ê°€ (í‘œì§€ ë‹¤ìŒë¶€í„°)
                    doc.addPage();
                    
                    // ì„¹ì…˜ ì œëª© HTMLë¡œ ìƒì„±
                    const titleDiv = document.createElement('div');
                    titleDiv.style.cssText = `
                        width: 794px;
                        height: 100px;
                        background: white;
                        padding: 30px;
                        font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
                        position: fixed;
                        left: -9999px;
                        top: 0;
                    `;
                    titleDiv.innerHTML = `
                        <h2 style="font-size: 28px; color: #1565C0; margin: 0; padding-bottom: 15px; border-bottom: 3px solid #4A90E2;">
                            ${i + 1}. ${analysis.title}
                        </h2>
                    `;
                    document.body.appendChild(titleDiv);
                    
                    // ì œëª© ìº¡ì²˜
                    const titleCanvas = await html2canvas(titleDiv, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    const titleImgData = titleCanvas.toDataURL('image/png');
                    doc.addImage(titleImgData, 'PNG', 0, 0, 210, 35);
                    
                    // ì œëª© div ì œê±°
                    document.body.removeChild(titleDiv);

                    // AI ë¶„ì„ ê²°ê³¼ ìº¡ì²˜
                    const aiResult = document.querySelector(`#${analysis.tab}AiResult .prime-analysis-result`);
                    
                    if (aiResult && aiResult.offsetHeight > 0) {
                        // html2canvasë¡œ ìº¡ì²˜
                        const canvas = await html2canvas(aiResult, {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#ffffff'
                        });
                        
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 170; // A4 ë„ˆë¹„ì— ë§ì¶¤
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        let yPosition = 40; // ì œëª© ì•„ë˜ ì‹œì‘
                        let remainingHeight = imgHeight;
                        let sourceY = 0;
                        
                        // ì´ë¯¸ì§€ê°€ í˜ì´ì§€ë³´ë‹¤ ê¸¸ë©´ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë¶„í• 
                        while (remainingHeight > 0) {
                            const availableHeight = 267 - yPosition; // A4 ë†’ì´ - ì—¬ë°±
                            const heightToAdd = Math.min(remainingHeight, availableHeight);
                            
                            // ìº”ë²„ìŠ¤ì˜ ì¼ë¶€ë¶„ë§Œ ì˜ë¼ì„œ ì¶”ê°€
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = canvas.width;
                            tempCanvas.height = (heightToAdd / imgWidth) * canvas.width;
                            
                            const ctx = tempCanvas.getContext('2d');
                            ctx.drawImage(
                                canvas,
                                0, (sourceY / imgHeight) * canvas.height,
                                canvas.width, (heightToAdd / imgWidth) * canvas.width,
                                0, 0,
                                canvas.width, (heightToAdd / imgWidth) * canvas.width
                            );
                            
                            const partialImgData = tempCanvas.toDataURL('image/png');
                            doc.addImage(partialImgData, 'PNG', 20, yPosition, imgWidth, heightToAdd);
                            
                            remainingHeight -= heightToAdd;
                            sourceY += heightToAdd;
                            
                            if (remainingHeight > 0) {
                                doc.addPage();
                                yPosition = 20;
                            }
                        }
                    } else {
                        // AI ë¶„ì„ì´ ì—†ëŠ” ê²½ìš° - HTMLë¡œ ë©”ì‹œì§€ ìƒì„±
                        const noAnalysisDiv = document.createElement('div');
                        noAnalysisDiv.style.cssText = `
                            width: 794px;
                            height: 200px;
                            background: white;
                            padding: 40px;
                            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
                            position: fixed;
                            left: -9999px;
                            top: 0;
                        `;
                        noAnalysisDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px; background: #F5F5F5; border-radius: 10px; border: 2px dashed #BBDEFB;">
                                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                                <div style="font-size: 20px; color: #666; margin-bottom: 15px;">
                                    AI ë¶„ì„ì´ ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                                </div>
                                <div style="font-size: 16px; color: #999;">
                                    ê° íƒ­ì—ì„œ "âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¶„ì„ì„ ìˆ˜í–‰í•˜ì„¸ìš”.
                                </div>
                            </div>
                        `;
                        document.body.appendChild(noAnalysisDiv);
                        
                        const noAnalysisCanvas = await html2canvas(noAnalysisDiv, {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#ffffff'
                        });
                        
                        const noAnalysisImgData = noAnalysisCanvas.toDataURL('image/png');
                        doc.addImage(noAnalysisImgData, 'PNG', 20, 40, 170, 70);
                        
                        document.body.removeChild(noAnalysisDiv);
                    }

                    // ì°¨íŠ¸ ìº¡ì²˜ (ìˆëŠ” ê²½ìš°)
                    const chartsContent = document.querySelector(`#${analysis.tab}Charts`);
                    if (chartsContent && chartsContent.classList.contains('open')) {
                        const chartCanvas = chartsContent.querySelector('canvas');
                        if (chartCanvas) {
                            doc.addPage();
                            
                            // ì°¨íŠ¸ ì œëª© HTMLë¡œ ìƒì„±
                            const chartTitleDiv = document.createElement('div');
                            chartTitleDiv.style.cssText = `
                                width: 794px;
                                height: 80px;
                                background: white;
                                padding: 20px;
                                font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
                                position: fixed;
                                left: -9999px;
                                top: 0;
                            `;
                            chartTitleDiv.innerHTML = `
                                <h3 style="font-size: 22px; color: #1565C0; margin: 0;">
                                    ğŸ“Š ì°¨íŠ¸ ì‹œê°í™”
                                </h3>
                            `;
                            document.body.appendChild(chartTitleDiv);
                            
                            const chartTitleCanvas = await html2canvas(chartTitleDiv, {
                                scale: 2,
                                useCORS: true,
                                logging: false,
                                backgroundColor: '#ffffff'
                            });
                            
                            const chartTitleImgData = chartTitleCanvas.toDataURL('image/png');
                            doc.addImage(chartTitleImgData, 'PNG', 0, 0, 210, 28);
                            
                            document.body.removeChild(chartTitleDiv);
                            
                            const chartImgData = chartCanvas.toDataURL('image/png');
                            doc.addImage(chartImgData, 'PNG', 20, 30, 170, 120);
                        }
                    }
                }

                // PDF ì €ì¥
                const timestamp = new Date().toISOString().slice(0, 10);
                doc.save(`ë©”íƒ€ë°ì´í„°_ë¶„ì„_í†µí•©_${timestamp}.pdf`);
                
                // ë²„íŠ¼ ë³µì›
                originalBtn.disabled = false;
                originalBtn.textContent = originalText;
                
                alert('âœ… í†µí•© PDF ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nëª¨ë“  ë¶„ì„ íƒ­ì˜ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                
                // ë²„íŠ¼ ë³µì›
                if (event && event.target) {
                    event.target.disabled = false;
                    event.target.textContent = 'ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ';
                }
            }
        }

        // ì¢…í•© í”Œë ˆì´ë¶ ìƒì„± í•¨ìˆ˜
        async function generateComprehensivePlaybook() {
            try {
                // Gemini API í™•ì¸
                if (!geminiApiKey) {
                    alert('âš ï¸ Gemini API í‚¤ë¥¼ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.\n\nAPI ì„¤ì • ì„¹ì…˜ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }

                // 4ê°œ íƒ­ AI ë¶„ì„ ê²°ê³¼ í™•ì¸
                const hasFrequency = aiAnalysisCache.frequency;
                const hasCombination = aiAnalysisCache.combination;
                const hasAssociation = aiAnalysisCache.association;
                const hasVisual = aiAnalysisCache.visual;

                if (!hasFrequency || !hasCombination || !hasAssociation || !hasVisual) {
                    alert('âš ï¸ ëª¨ë“  ë¶„ì„ íƒ­ì—ì„œ AI ë¶„ì„ì„ ë¨¼ì € ìˆ˜í–‰í•´ì£¼ì„¸ìš”.\n\nëˆ„ë½ëœ ë¶„ì„:\n' +
                        (!hasFrequency ? '- ë¹ˆë„ ë¶„ì„\n' : '') +
                        (!hasCombination ? '- ì¡°í•© íŒ¨í„´ ë¶„ì„\n' : '') +
                        (!hasAssociation ? '- ì—°ê´€ ê·œì¹™ ë¶„ì„\n' : '') +
                        (!hasVisual ? '- ë¹„ì£¼ì–¼ ë§µí•‘ ë¶„ì„\n' : ''));
                    return;
                }

                // ë¡œë”© ì‹œì‘
                const originalBtn = event.target;
                const originalText = originalBtn.textContent;
                originalBtn.disabled = true;
                originalBtn.textContent = 'ğŸ“˜ í”Œë ˆì´ë¶ ìƒì„± ì¤‘... (30ì´ˆ~1ë¶„ ì†Œìš”)';

                // ê° ë¶„ì„ ê²°ê³¼ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                const extractTextFromHTML = (htmlString) => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlString;
                    return tempDiv.textContent || tempDiv.innerText || '';
                };

                const frequencyText = extractTextFromHTML(hasFrequency);
                const combinationText = extractTextFromHTML(hasCombination);
                const associationText = extractTextFromHTML(hasAssociation);
                const visualText = extractTextFromHTML(hasVisual);

                // Geminiì—ê²Œ í†µí•© ìš”ì•½ ìš”ì²­
                const prompt = `# ì´ˆì••ì¶• í”Œë ˆì´ë¶ ìƒì„± ë¯¸ì…˜ ğŸ¯

ìš°ë¦¬ê°€ 4ê°€ì§€ ë¶„ì„ì„ ë‹¤ ëŒë ¸ì–´ìš”. ì´ì œ ì´ê±¸ **ì‹¤ì „ì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì´ˆê°„ê²° í”Œë ˆì´ë¶**ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”!

## ğŸ“Š 4ê°€ì§€ ë¶„ì„ ê²°ê³¼
${frequencyText.slice(0, 2500)}
${combinationText.slice(0, 2500)}
${associationText.slice(0, 2500)}
${visualText.slice(0, 2500)}

---

## ğŸ¨ ì‘ì„± ìŠ¤íƒ€ì¼ (ì´ê²Œ ì œì¼ ì¤‘ìš”!)

**ë§íˆ¬:**
- ì™„ì „ ì¹œêµ¬í•œí…Œ ë§í•˜ë“¯ì´ í¸í•˜ê²Œ! 
- "~í•´ì•¼ í•©ë‹ˆë‹¤" âŒ â†’ "~í•˜ë©´ ë¼ìš”" âœ…
- "ë¶„ì„ ê²°ê³¼ì— ë”°ë¥´ë©´" âŒ â†’ "ë°ì´í„° ë³´ë‹ˆê¹Œ" âœ…
- ì´ëª¨ì§€ ë§ì´ ì¨ì£¼ì„¸ìš” ğŸ”¥ğŸ’¡âœ¨

**ë¶„ëŸ‰:**
- PDFë¡œ ë§Œë“¤ë©´ **ì»¤ë²„ í¬í•¨ 4í˜ì´ì§€ ì´ë‚´!** (ì§„ì§œ ì¤‘ìš”!)
- ê° ì„¹ì…˜ë§ˆë‹¤ **í•µì‹¬ë§Œ ë”±ë”±** ì •ë¦¬
- ë¶ˆí•„ìš”í•œ ì„¤ëª…ì€ ì „ë¶€ ì‚­ì œ
- ì§§ê³  ê°•ë ¬í•˜ê²Œ!

**ë§ˆí¬ë‹¤ìš´:**
- ## (H2), ### (H3), #### (H4) ì‚¬ìš©
- í•˜ìœ„ í•­ëª©ì€ ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°
- ì˜ˆì‹œ:

### ì„¹ì…˜
- í•­ëª©
  - ìƒì„¸ (ê³µë°± 2ê°œ!)

## ğŸ“‹ í•„ìˆ˜ ì„¹ì…˜ (ì´ê²ƒë§Œ!)

### ğŸ¯ í•œì¤„ ìš”ì•½
ë°ì´í„° ì „ì²´ë¥¼ **ë”± í•œì¤„**ë¡œ! (20ì ì´ë‚´)

### ğŸ”¥ ì§€ê¸ˆ ë°”ë¡œ í•  ê²ƒ TOP 3

#### 1. [ì•¡ì…˜ ì œëª© - 5ì ì´ë‚´]
- ì™œ? (í•œì¤„!)
  - ê·¼ê±° ë°ì´í„° (í•œì¤„!)
- ì–´ë–»ê²Œ? (í•œì¤„!)
  - êµ¬ì²´ì  ë°©ë²• (í•œì¤„!)

#### 2. [ì•¡ì…˜ ì œëª©]
(ë™ì¼ êµ¬ì¡°)

#### 3. [ì•¡ì…˜ ì œëª©]
(ë™ì¼ êµ¬ì¡°)

### âš ï¸ ì ˆëŒ€ ê¸ˆì§€ 3ê°€ì§€
- ì‹¤íŒ¨ íŒ¨í„´ 1: [ì œëª©]
  - ì™œ í”¼í•´ì•¼ í• ê¹Œ? (í•œì¤„!)
  - ëŒ€ì‹  ì´ë ‡ê²Œ (í•œì¤„!)
- ì‹¤íŒ¨ íŒ¨í„´ 2: [ì œëª©]
  - ì™œ í”¼í•´ì•¼ í• ê¹Œ?
  - ëŒ€ì‹  ì´ë ‡ê²Œ
- ì‹¤íŒ¨ íŒ¨í„´ 3: [ì œëª©]
  - ì™œ í”¼í•´ì•¼ í• ê¹Œ?
  - ëŒ€ì‹  ì´ë ‡ê²Œ

### ğŸ’ ì„±ê³µ ê³µì‹
ë°ì´í„°ë¡œ ê²€ì¦ëœ í™©ê¸ˆ ì¡°í•©ì„ **3ì¤„ ì´ë‚´**ë¡œ ë”± ì •ë¦¬

### ğŸš€ 30ë¶„ ì•¡ì…˜í”Œëœ
ì˜¤ëŠ˜ ë‹¹ì¥ 30ë¶„ë§Œ íˆ¬ìí•´ì„œ í•  ìˆ˜ ìˆëŠ” ê²ƒ **3ê°œ**ë§Œ
- [ ] ì•¡ì…˜ 1 (êµ¬ì²´ì ìœ¼ë¡œ!)
- [ ] ì•¡ì…˜ 2 (êµ¬ì²´ì ìœ¼ë¡œ!)
- [ ] ì•¡ì…˜ 3 (êµ¬ì²´ì ìœ¼ë¡œ!)

---

## ğŸš¨ ì ˆëŒ€ ê·œì¹™
1. **ì´ ë¶„ëŸ‰: A4 2.5í˜ì´ì§€ ë¶„ëŸ‰** (ì»¤ë²„ ì œì™¸)
2. ëª¨ë“  ì„¤ëª…ì€ **1~2ì¤„ ì´ë‚´**
3. ì¤‘ë³µ ë‚´ìš©ì€ **ì „ë¶€ ì‚­ì œ**
4. "~ë‹ˆë‹¤" âŒ "~í•´ìš”/~ì£ /~ë„¤ìš”" âœ…
5. ìˆ«ìê°€ ìˆìœ¼ë©´ **ë°˜ë“œì‹œ í¬í•¨** (ì˜ˆ: 70% â†’ 10ê°œ ì¤‘ 7ê°œ)
6. í•˜ìœ„ í•­ëª©ì€ **ê³µë°± 2ê°œ ë“¤ì—¬ì“°ê¸°!**

ì§€ê¸ˆ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ, ê¹”ë”í•˜ê²Œ, ì¹œê·¼í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”! ğŸ‰`;

                // Gemini API í˜¸ì¶œ
                const playbookResult = await callGeminiAPI(prompt);

                if (!playbookResult) {
                    throw new Error('í”Œë ˆì´ë¶ ìƒì„± ì‹¤íŒ¨');
                }

                // PDF ìƒì„±
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const today = new Date().toLocaleDateString('ko-KR');
                const fileName = uploadedFiles[currentFileIndex]?.name || 'ë°ì´í„°';
                
                // í‘œì§€ í˜ì´ì§€
                const coverDiv = document.createElement('div');
                coverDiv.style.cssText = `
                    width: 794px;
                    height: 1123px;
                    background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
                    padding: 80px;
                    font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
                    position: fixed;
                    left: -9999px;
                    top: 0;
                    color: white;
                `;
                coverDiv.innerHTML = `
                    <div style="text-align: center; margin-top: 120px;">
                        <div style="font-size: 72px; margin-bottom: 40px;">ğŸ”¥</div>
                        <h1 style="font-size: 48px; margin-bottom: 30px; font-weight: 700; color: white;">
                            ì„±ê³µ í”Œë ˆì´ë¶
                        </h1>
                        <div style="font-size: 28px; margin-bottom: 80px; opacity: 0.95; color: white;">
                            ë°ì´í„°ê°€ ì•Œë ¤ì£¼ëŠ” ì •ë‹µ
                        </div>
                        <div style="width: 80%; height: 3px; background: rgba(255,255,255,0.5); margin: 80px auto;"></div>
                        <div style="font-size: 20px; opacity: 0.9; margin-bottom: 15px; color: white;">
                            ğŸ“Š ${fileName}
                        </div>
                        <div style="font-size: 18px; opacity: 0.9; color: white;">
                            ğŸ“… ${today}
                        </div>
                    </div>
                `;
                document.body.appendChild(coverDiv);
                
                const coverCanvas = await html2canvas(coverDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#9C27B0'
                });
                
                const coverImgData = coverCanvas.toDataURL('image/png');
                doc.addImage(coverImgData, 'PNG', 0, 0, 210, 297);
                document.body.removeChild(coverDiv);

                // í”Œë ˆì´ë¶ ë‚´ìš© ì¶”ê°€
                doc.addPage();
                
                // ì œëª©
                const titleDiv = document.createElement('div');
                titleDiv.style.cssText = `
                    width: 794px;
                    height: 100px;
                    background: white;
                    padding: 30px;
                    font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
                    position: fixed;
                    left: -9999px;
                    top: 0;
                `;
                titleDiv.innerHTML = `
                    <h2 style="font-size: 32px; color: #9C27B0; margin: 0; padding-bottom: 20px; border-bottom: 4px solid #9C27B0;">
                        ğŸš€ ë‹¹ì¥ ì¨ë¨¹ëŠ” ì‹¤ì „ ê°€ì´ë“œ
                    </h2>
                `;
                document.body.appendChild(titleDiv);
                
                const titleCanvas = await html2canvas(titleDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const titleImgData = titleCanvas.toDataURL('image/png');
                doc.addImage(titleImgData, 'PNG', 0, 0, 210, 35);
                document.body.removeChild(titleDiv);

                // í”Œë ˆì´ë¶ ë³¸ë¬¸ ìº¡ì²˜
                const playbookDiv = document.createElement('div');
                playbookDiv.className = 'prime-analysis-result';
                playbookDiv.style.cssText = `
                    width: 794px;
                    background: white;
                    padding: 40px;
                    font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
                    position: fixed;
                    left: -9999px;
                    top: 0;
                `;
                playbookDiv.innerHTML = formatMarkdown(playbookResult);
                document.body.appendChild(playbookDiv);

                const playbookCanvas = await html2canvas(playbookDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                const imgData = playbookCanvas.toDataURL('image/png');
                const imgWidth = 170;
                const imgHeight = (playbookCanvas.height * imgWidth) / playbookCanvas.width;
                
                let yPosition = 40;
                let remainingHeight = imgHeight;
                let sourceY = 0;
                
                while (remainingHeight > 0) {
                    const availableHeight = 267 - yPosition;
                    const heightToAdd = Math.min(remainingHeight, availableHeight);
                    
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = playbookCanvas.width;
                    tempCanvas.height = (heightToAdd / imgWidth) * playbookCanvas.width;
                    
                    const ctx = tempCanvas.getContext('2d');
                    ctx.drawImage(
                        playbookCanvas,
                        0, (sourceY / imgHeight) * playbookCanvas.height,
                        playbookCanvas.width, (heightToAdd / imgWidth) * playbookCanvas.width,
                        0, 0,
                        playbookCanvas.width, (heightToAdd / imgWidth) * playbookCanvas.width
                    );
                    
                    const partialImgData = tempCanvas.toDataURL('image/png');
                    doc.addImage(partialImgData, 'PNG', 20, yPosition, imgWidth, heightToAdd);
                    
                    remainingHeight -= heightToAdd;
                    sourceY += heightToAdd;
                    
                    if (remainingHeight > 0) {
                        doc.addPage();
                        yPosition = 20;
                    }
                }

                document.body.removeChild(playbookDiv);

                // PDF ì €ì¥
                const timestamp = new Date().toISOString().slice(0, 10);
                doc.save(`ì„±ê³µ_í”Œë ˆì´ë¶_${timestamp}.pdf`);
                
                // ë²„íŠ¼ ë³µì›
                originalBtn.disabled = false;
                originalBtn.textContent = originalText;
                
                alert('ğŸ”¥ í”Œë ˆì´ë¶ ì™„ì„±!\n\nì»¤ë²„ í¬í•¨ 4í˜ì´ì§€ ì´ë‚´ë¡œ í•µì‹¬ë§Œ ì••ì¶•í–ˆì–´ìš”.\nì§€ê¸ˆ ë°”ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ì‹¤ì „ ê°€ì´ë“œì…ë‹ˆë‹¤!');

            } catch (error) {
                console.error('í”Œë ˆì´ë¶ ìƒì„± ì˜¤ë¥˜:', error);
                alert('í”Œë ˆì´ë¶ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                
                if (event && event.target) {
                    event.target.disabled = false;
                    event.target.textContent = 'ğŸ“˜ ì¢…í•© í”Œë ˆì´ë¶ ìƒì„±';
                }
            }
        }

    </script>
</body>
</html>
